/*! For license information please see 5e3a794d11d4358a42e6.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){i=!0,a=e},f:function(){try{u||null==n.return||n.return()}finally{if(i)throw a}}}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,u,i=[],c=!0,s=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(i.push(r.value),i.length!==t);c=!0);}catch(e){s=!0,o=e}finally{try{if(!c&&null!=n.return&&(u=n.return(),Object(u)!==u))return}finally{if(s)throw o}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _readOnlyError(e){throw new TypeError('"'+e+'" is read-only')}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",u=o.asyncIterator||"@@asyncIterator",i=o.toStringTag||"@@toStringTag";function c(e,t,n,r){return Object.defineProperty(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r})}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function s(t,n,r,o){var a=n&&n.prototype instanceof f?n:f,u=Object.create(a.prototype);return c(u,"_invoke",function(t,n,r){var o=1;return function(a,u){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===a)throw u;return{value:e,done:!0}}for(r.method=a,r.arg=u;;){var i=r.delegate;if(i){var c=x(i,r);if(c){if(c===d)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(1===o)throw o=4,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=3;var s=l(t,n,r);if("normal"===s.type){if(o=r.done?4:2,s.arg===d)continue;return{value:s.arg,done:r.done}}"throw"===s.type&&(o=4,r.method="throw",r.arg=s.arg)}}}(t,r,new k(o||[])),!0),u}function l(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=s;var d={};function f(){}function m(){}function h(){}var p={};c(p,a,(function(){return this}));var g=Object.getPrototypeOf,y=g&&g(g(C([])));y&&y!==n&&r.call(y,a)&&(p=y);var v=h.prototype=f.prototype=Object.create(p);function b(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function n(o,a,u,i){var c=l(e[o],e,a);if("throw"!==c.type){var s=c.arg,d=s.value;return d&&"object"==_typeof(d)&&r.call(d,"__await")?t.resolve(d.__await).then((function(e){n("next",e,u,i)}),(function(e){n("throw",e,u,i)})):t.resolve(d).then((function(e){s.value=e,u(s)}),(function(e){return n("throw",e,u,i)}))}i(c.arg)}var o;c(this,"_invoke",(function(e,r){function a(){return new t((function(t,o){n(e,r,t,o)}))}return o=o?o.then(a,a):a()}),!0)}function x(t,n){var r=n.method,o=t.i[r];if(o===e)return n.delegate=null,"throw"===r&&t.i.return&&(n.method="return",n.arg=e,x(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),d;var a=l(o,t.i,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,d;var u=a.arg;return u?u.done?(n[t.r]=u.value,n.next=t.n,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,d):u:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,d)}function D(e){this.tryEntries.push(e)}function E(t){var n=t[4]||{};n.type="normal",n.arg=e,t[4]=n}function k(e){this.tryEntries=[[-1]],e.forEach(D,this),this.reset(!0)}function C(t){if(null!=t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,u=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return u.next=u}}throw new TypeError(_typeof(t)+" is not iterable")}return m.prototype=h,c(v,"constructor",h),c(h,"constructor",m),m.displayName=c(h,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===m||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,c(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},t.awrap=function(e){return{__await:e}},b(w.prototype),c(w.prototype,u,(function(){return this})),t.AsyncIterator=w,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var u=new w(s(e,n,r,o),a);return t.isGeneratorFunction(n)?u:u.next().then((function(e){return e.done?e.value:u.next()}))},b(v),c(v,i,"Generator"),c(v,a,(function(){return this})),c(v,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.unshift(r);return function e(){for(;n.length;)if((r=n.pop())in t)return e.value=r,e.done=!1,e;return e.done=!0,e}},t.values=C,k.prototype={constructor:k,reset:function(t){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(E),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(e){u.type="throw",u.arg=t,n.next=e}for(var o=n.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],u=a[4],i=this.prev,c=a[1],s=a[2];if(-1===a[0])return r("end"),!1;if(!c&&!s)throw Error("try statement without catch or finally");if(null!=a[0]&&a[0]<=i){if(i<c)return this.method="next",this.arg=e,r(c),!0;if(i<s)return r(s),!1}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r[0]>-1&&r[0]<=this.prev&&this.prev<r[2]){var o=r;break}}o&&("break"===e||"continue"===e)&&o[0]<=t&&t<=o[2]&&(o=null);var a=o?o[4]:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o[2],d):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[2]===e)return this.complete(n[4],n[3]),E(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]===e){var r=n[4];if("throw"===r.type){var o=r.arg;E(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={i:C(t),r:n,n:r},"next"===this.method&&(this.arg=e),d}},t}function asyncGeneratorStep(e,t,n,r,o,a,u){try{var i=e[a](u),c=i.value}catch(e){return void n(e)}i.done?t(c):Promise.resolve(c).then(r,o)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function u(e){asyncGeneratorStep(a,r,o,u,i,"next",e)}function i(e){asyncGeneratorStep(a,r,o,u,i,"throw",e)}u(void 0)}))}}function levenshtein(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;for(var n=[],r=0;r<=t.length;r++)n[r]=[r];for(var o=0;o<=e.length;o++)n[0][o]=o;for(var a=1;a<=t.length;a++)for(var u=1;u<=e.length;u++)t.charAt(a-1)===e.charAt(u-1)?n[a][u]=n[a-1][u-1]:n[a][u]=Math.min(n[a-1][u-1]+1,n[a][u-1]+1,n[a-1][u]+1);return n[t.length][e.length]}function similarity(e,t){return e||t?e&&t?1-levenshtein(e,t)/Math.max(e.length,t.length):0:1}function applyOfficeThemeColor(){var e="#2d89ef";Office.context&&Office.context.host&&"excel"===Office.context.host.toLowerCase()&&(e="#217346"),Office.context&&Office.context.officeTheme&&(e=Office.context.officeTheme.accent1||Office.context.officeTheme.primaryColor||e),document.documentElement.style.setProperty("--primary-color",e),document.documentElement.style.setProperty("--primary-color-hover",shadeColor(e,-20))}function shadeColor(e,t){var n=parseInt(e.substring(1,3),16),r=parseInt(e.substring(3,5),16),o=parseInt(e.substring(5,7),16);return"#"+(16777216+((n=(n=parseInt(n*(100+t)/100))<255?n:255)<<16)+((r=(r=parseInt(r*(100+t)/100))<255?r:255)<<8)+(o=(o=parseInt(o*(100+t)/100))<255?o:255)).toString(16).slice(1)}function showSection(e){document.getElementById("app-body").style.display="flex",document.querySelectorAll(".welcome-panel, .harmonisation-container, .tools-container").forEach((function(e){e.classList.remove("active-section"),e.style.display="none"}));var t=document.querySelector(e);t&&(t.classList.add("active-section"),t.style.display=".tools-container"===e?"flex":"block",t.style.removeProperty("display"),".welcome-panel"===e||".harmonisation-container"===e?t.style.display="block":".tools-container"===e&&(t.style.display="flex"))}function setActiveNav(e){document.querySelectorAll(".mini-nav-btn").forEach((function(e){return e.classList.remove("active")})),document.getElementById(e).classList.add("active")}function initHelpSystem(){var e=document.createElement("button");e.id="show-help-btn",e.innerHTML="?",e.style.cssText="position:fixed;top:20px;right:20px;width:32px;height:32px;border-radius:4px;background:#1890ff;color:white;font-size:16px;border:none;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;align-items:center;justify-content:center;",document.body.appendChild(e),e.onclick=function(){var e=document.getElementById("help-modal");e&&(e.style.display="block")}}function getCurrentBddWorkbook(){var e=Office.context.document.settings.get("bddWorkbookData");return e?XLSX.read(new Uint8Array(e),{type:"array"}):null}function getCurrentBddFilename(){return Office.context.document.settings.get("bddWorkbookName")||""}function updateMappingTable(){var e=document.getElementById("theme-select").value,t=getCurrentBddWorkbook();if(t&&e){var n=t.Sheets[e],r=XLSX.utils.sheet_to_json(n,{header:1}),o=document.querySelector("#mapping-table tbody");o.innerHTML="";var a=document.getElementById("search-mapping"),u=document.createElement("datalist");u.id="harmonisation-suggestions";for(var i=new Set,c=1;c<r.length;c++)r[c]&&r[c][1]&&i.add(r[c][1]);i.forEach((function(e){var t=document.createElement("option");t.value=e,u.appendChild(t)})),document.body.appendChild(u),a.setAttribute("list","harmonisation-suggestions");var s=r.slice(1).map((function(e){return{brut:e[0],harm:e[1]}}));a.addEventListener("input",(function(e){l(e.target.value.trim())})),l(),document.getElementById("search-section").style.display="block"}else document.getElementById("search-section").style.display="none";function l(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";o.innerHTML="",s.filter((function(t){if(!e)return!0;var n=e.toLowerCase();return t.brut&&t.brut.toString().toLowerCase().includes(n)||t.harm&&t.harm.toString().toLowerCase().includes(n)})).forEach((function(e){var t=document.createElement("tr");t.innerHTML="\n        <td>".concat(e.brut,'</td>\n        <td class="apres-cell">').concat(e.harm,"</td>\n      "),o.appendChild(t)}))}}function initHarmonisationHandlers(){document.getElementById("nav-home").addEventListener("click",(function(){showSection(".welcome-panel"),setActiveNav("nav-home")})),document.getElementById("nav-harmo").addEventListener("click",(function(){showSection(".harmonisation-container"),setActiveNav("nav-harmo")}));var e=document.getElementById("show-help-btn"),t=document.getElementById("help-modal"),n=document.getElementById("close-help-modal");e&&t&&n&&(e.onclick=function(){t.style.display="block"},n.onclick=function(){t.style.display="none"},window.onclick=function(e){e.target===t&&(t.style.display="none")});var r=null,o=document.getElementById("select-column-btn");o?o.onclick=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["columnIndex","rowCount","columnCount","address"]),e.next=4,t.sync();case 4:if(1===n.columnCount){e.next=7;break}return d("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 7:window.selectedColumnRange=n.address,o.textContent="Colonne sélectionnée : ".concat(n.address),p();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)}))):console.warn("select-column-btn manquant");var a=document.getElementById("load-bdd-btn");a?a.onclick=function(){var e=document.getElementById("bdd-file-input");e?(console.log("Ouverture explorateur de fichiers BDD"),d("Ouverture de l'explorateur de fichiers...","info"),e.click()):(d("Erreur : input file BDD introuvable.","error"),console.warn("bdd-file-input manquant"))}:console.warn("load-bdd-btn manquant");var u=document.getElementById("bdd-file-input");u?u.onchange=function(e){var t=e.target.files[0];if(t)if(getCurrentBddFilename()!==t.name){var n=new FileReader;n.onload=function(e){var n=new Uint8Array(e.target.result),r=XLSX.read(n,{type:"array"});Office.context.document.settings.set("bddWorkbookData",Array.from(n)),Office.context.document.settings.set("bddWorkbookName",t.name),Office.context.document.settings.saveAsync(),window.bddFilename=t.name,p();var o=document.getElementById("theme-select");o?(o.innerHTML="",r.SheetNames.forEach((function(e){var t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}))):console.warn("theme-select manquant");var u=document.getElementById("theme-section");u&&(u.style.display="block");var i=document.getElementById("harmonize-btn");i&&(i.style.display="inline-block");var c=document.getElementById("bdd-filename");c?(c.textContent="Fichier chargé : ".concat(t.name),c.style.display="inline"):console.warn("bdd-filename manquant"),a&&(a.textContent="Changer de BDD"),updateMappingTable()},n.readAsArrayBuffer(t)}else d("Ce fichier est déjà chargé.","info")}:console.warn("bdd-file-input manquant");var i=document.getElementById("theme-select");function c(e,t){if(!e||!t)return 0;for(var n=function(e,t){if(e===t)return 1;for(var n=e.length,r=t.length,o=Math.floor(Math.max(n,r)/2)-1,a=new Array(n).fill(!1),u=new Array(r).fill(!1),i=0,c=0;c<n;c++)for(var s=Math.max(0,c-o),l=Math.min(c+o+1,r),d=s;d<l;d++)if(!u[d]&&e[c]===t[d]){a[c]=!0,u[d]=!0,i++;break}if(0===i)return 0;for(var f=0,m=0,h=0;h<n;h++)if(a[h]){for(;!u[m];)m++;e[h]!==t[m]&&f++,m++}return(i/n+i/r+(i-(f=Math.floor(f/2)))/i)/3}(e=e.toString(),t=t.toString()),r=0,o=0;o<Math.min(e.length,t.length,4)&&e[o]===t[o];o++)r++;return n+.1*r*(1-n)}i?i.onchange=function(){updateMappingTable()}:console.warn("theme-select manquant");var s=document.getElementById("search-mapping");function l(e){if(!e||"string"!=typeof e)return"";var t=e.normalize("NFD").replace(/\u0300-\u036F/g,"");return(t=(t=t.toUpperCase()).replace(/[^A-Z0-9 ]/g," ")).replace(/\s+/g," ").trim()}function d(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=document.getElementById("global-msg");n.textContent=e,n.style.display="block",n.style.background="error"===t?"#fff1f0":"#fffbe6",n.style.color="error"===t?"#a8071a":"#b36b00",n.style.border="error"===t?"1px solid #ffa39e":"1px solid #ffe58f",setTimeout((function(){n.style.display="none"}),4e3)}s?s.oninput=function(e){var t=e.target.value.toLowerCase(),n=i?i.value:null,r=getCurrentBddWorkbook();if(r&&n){var o=r.Sheets[n],a=XLSX.utils.sheet_to_json(o,{header:1}),u=document.querySelector("#mapping-table tbody");if(u){if(u.innerHTML="",!t){for(var s=1;s<a.length;s++)if(a[s]){var d=document.createElement("tr");d.innerHTML="<td>".concat(a[s][0]||"","</td><td>").concat(a[s][1]||"","</td><td></td>"),u.appendChild(d)}return}for(var f=[],m=1;m<a.length;m++)if(a[m]&&a[m][0]){var h=(a[m][0]||"").toString(),p=(a[m][1]||"").toString(),g=l(h),y=l(t),v=similarity(y,g),b=c(y,g),w=Math.round(100*(.5*v+.5*b));(w>=40||h.toLowerCase().includes(t)||p.toLowerCase().includes(t))&&f.push({brut:h,harm:p,score:w})}f.sort((function(e,t){return t.score-e.score})),f.forEach((function(e){var t=document.createElement("tr");t.innerHTML="\n            <td>".concat(e.brut,'</td>\n            <td class="apres-cell">').concat(e.harm,"</td>\n          "),u.appendChild(t)}))}else console.warn("mapping-table tbody manquant")}}:console.warn("search-mapping manquant"),window.normaliserTexte=l,window.showGlobalMsg=d;var f=document.getElementById("harmonize-btn");function m(e){document.getElementById("tool-result-msg").textContent=e,setTimeout((function(){document.getElementById("tool-result-msg").textContent=""}),3500)}function h(e,t){var n=document.getElementById(e);n&&("function"==typeof t?n.onclick=t:t&&"function"==typeof t.then&&(n.onclick=function(){return t.catch((function(e){return console.error("Error in click handler:",e)}))}))}function p(){var e=document.getElementById("harmo-status");if(e){var t=window.selectedColumnRange?"Colonne sélectionnée : <b>".concat(window.selectedColumnRange,"</b>"):'<span style="color:#a8071a">Aucune colonne sélectionnée</span>',n=window.bddFilename?"BDD chargée : <b>".concat(window.bddFilename,"</b>"):'<span style="color:#a8071a">Aucune BDD chargée</span>';e.innerHTML=t+" &nbsp; | &nbsp; "+n}}function g(e,t,n){var r=document.getElementById("modal-harmonisation"),o=document.querySelector("#harmonisation-table tbody");o.innerHTML="";var a=document.getElementById("harmonisation-values");a||((a=document.createElement("datalist")).id="harmonisation-values",document.body.appendChild(a));var u=new Set;if(window.bddWorkbook&&n)for(var i=window.bddWorkbook.Sheets[n],c=XLSX.utils.sheet_to_json(i,{header:1}),s=1;s<c.length;s++)c[s]&&c[s][1]&&u.add(c[s][1]);a.innerHTML=Array.from(u).map((function(e){return'<option value="'.concat(e,'">')})).join("");var l,f=JSON.parse(JSON.stringify(e)),m=new Set,h=[],p=_createForOfIteratorHelper(e);try{for(p.s();!(l=p.n()).done;){var g=l.value,b=g.apres||g.suggestions&&g.suggestions[0]&&g.suggestions[0].harmonise||"",w=y(b);if(b){if(m.has(w))continue;m.add(w),h.push(g)}else h.push(g)}}catch(e){p.e(e)}finally{p.f()}h.forEach((function(t,n){var r=document.createElement("tr");r.setAttribute("data-idx",e.indexOf(t)),r.style.background="BDD exacte"===t.source?"#f6ffed":"Suggestion unique"===t.source||"Suggestion"===t.source?"#e6fffb":"Manuel"===t.source?"#fff7e6":"#fff1f0";var a,u=t.avant||"",i=t.apres||"",c=t.suggestions||[],s=new Set,l=[],d=_createForOfIteratorHelper(c);try{for(d.s();!(a=d.n()).done;){var f=a.value;if(f.harmonise){var m=y(f.harmonise);s.has(m)||(s.add(m),l.push(f))}}}catch(e){d.e(e)}finally{d.f()}r.innerHTML='\n        <td class="avant-cell">'.concat(u,'</td>\n        <td class="apres-cell">').concat(i,'</td>\n        <td class="suggestions-cell">\n          ').concat(l.map((function(n,r){return'\n            <button class="suggestion-btn '.concat(i===n.harmonise?"selected":"",'"\n                    data-idx="').concat(e.indexOf(t),'"\n                    data-val="').concat(n.harmonise,'"\n                    style="background: ').concat(i===n.harmonise?"#52c41a":"#f0f5ff",";\n                           color: ").concat(i===n.harmonise?"#fff":"#333",";\n                           font-weight: ").concat(i===n.harmonise?"600":"normal",'">\n              ').concat(n.harmonise," (").concat(n.score,"%)\n            </button>\n          ")})).join(" "),'\n        </td>\n        <td class="manuel-cell">\n          <div style="position: relative;">\n            <input type="text" \n                   class="manuel-input" \n                   value="').concat(i,'"\n                   list="harmonisation-values"\n                   placeholder="Saisie manuelle..."\n                   style="width: 100%; padding: 4px; border: 1px solid #d9d9d9; border-radius: 4px;">\n          </div>\n        </td>\n      '),o.appendChild(r)})),r.style.display="block";var x=document.getElementById("close-modal");x&&(x.onclick=function(){r.style.display="none"});var E=document.getElementById("cancel-harmonisation-btn");E&&(E.onclick=function(){Object.keys(f).forEach((function(t){e[t]=JSON.parse(JSON.stringify(f[t]))})),o.querySelectorAll("tr").forEach((function(t){var n=parseInt(t.getAttribute("data-idx")),r=e[n];if(r){var o=t.querySelector(".apres-cell");o&&(o.textContent=r.apres||"");var a=t.querySelector(".manuel-input");a&&(a.value=r.apres||""),t.style.background="BDD exacte"===r.source?"#f6ffed":"Suggestion unique"===r.source||"Suggestion"===r.source?"#e6fffb":"Manuel"===r.source?"#fff7e6":"#fff1f0",t.querySelectorAll(".suggestion-btn").forEach((function(e){var t=e.getAttribute("data-val"),n=r.apres===t;e.style.background=n?"#52c41a":"#f0f5ff",e.style.color=n?"#fff":"#333",e.style.fontWeight=n?"600":"normal"}))}})),r.style.display="none"});var k=document.getElementById("apply-harmonisation-btn");k&&(k.onclick=_asyncToGenerator(_regeneratorRuntime().mark((function n(){var o,a,u,i;return _regeneratorRuntime().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(o=e.map((function(e){return[e.apres||""]})),a=document.getElementById("theme-select").value,u=e.filter((function(e){return e.avant&&e.apres&&"BDD exacte"!==e.source})).map((function(e){return[e.avant,e.apres]})),!(u.length>0)){n.next=9;break}return window.newHarmoRowsByTheme||(window.newHarmoRowsByTheme={}),window.newHarmoRowsByTheme[a]||(window.newHarmoRowsByTheme[a]=[]),(i=window.newHarmoRowsByTheme[a]).push.apply(i,_toConsumableArray(u)),n.next=9,v(window.newHarmoRowsByTheme);case 9:return n.next=11,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){var r,a,u;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.workbook.worksheets.getActiveWorksheet().getRange(t)).load(["rowCount","columnCount"]),e.next=4,n.sync();case 4:return a=document.querySelector('input[name="harmo-dest"]:checked').value,(u="replace"===a?r:r.getOffsetRange(0,1)).load(["rowCount","columnCount","address"]),e.next=9,n.sync();case 9:for(;o.length<r.rowCount;)o.push([""]);return o.length>r.rowCount&&(o.length=r.rowCount),u.values=o,e.next=14,n.sync();case 14:window.lastHarmonisation={address:u.address,values:o},document.getElementById("undo-harmonisation-btn").style.display="inline-block";case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:r.style.display="none",d("Harmonisation appliquée avec succès.","success");case 13:case"end":return n.stop()}}),n)})))),setTimeout((function(){o.querySelectorAll(".suggestion-btn").forEach((function(t){t.onclick=function(n){var r=parseInt(t.getAttribute("data-idx")),a=t.getAttribute("data-val");if(!isNaN(r)&&e[r]){e[r].apres=a,e[r].source="Suggestion";var u=o.querySelector("tr[data-idx='".concat(r,"']"));if(u){var i=u.querySelector(".apres-cell"),c=u.querySelector(".manuel-input");i&&(i.textContent=a),c&&(c.value=a),u.style.background="#e6fffb",u.querySelectorAll(".suggestion-btn").forEach((function(e){e.style.background="#f0f5ff",e.style.color="#333",e.style.fontWeight="normal"})),t.style.background="#52c41a",t.style.color="#fff",t.style.fontWeight="600"}}else console.warn("Index invalide ou ligne non trouvée:",r)}})),o.querySelectorAll(".manuel-input").forEach((function(t){t.onchange=function(n){var r=t.closest("tr");if(r){var o=parseInt(r.getAttribute("data-idx"));if(!isNaN(o)&&e[o]){var a=t.value.trim();e[o].apres=a,e[o].source="Manuel";var u=r.querySelector(".apres-cell");u&&(u.textContent=a),r.style.background="#fff7e6",r.querySelectorAll(".suggestion-btn").forEach((function(e){e.style.background="#f0f5ff",e.style.color="#333",e.style.fontWeight="normal"}))}else console.warn("Index invalide ou ligne non trouvée:",o)}}}))}),0),D()}function y(e){if(!e||"string"!=typeof e)return"";var t=e.normalize("NFD").replace(/[\0-]/g,(function(e){return e.normalize("NFD").replace(/(?:[\^`\xA8\xAF\xB4\xB7\xB8\u02B0-\u034E\u0350-\u0357\u035D-\u0362\u0374\u0375\u037A\u0384\u0385\u0483-\u0487\u0559\u0591-\u05A1\u05A3-\u05BD\u05BF\u05C1\u05C2\u05C4\u064B-\u0652\u0657\u0658\u06DF\u06E0\u06E5\u06E6\u06EA-\u06EC\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F5\u0818\u0819\u0898-\u089F\u08C9-\u08D2\u08E3-\u08FE\u093C\u094D\u0951-\u0954\u0971\u09BC\u09CD\u0A3C\u0A4D\u0ABC\u0ACD\u0AFD-\u0AFF\u0B3C\u0B4D\u0B55\u0BCD\u0C3C\u0C4D\u0CBC\u0CCD\u0D3B\u0D3C\u0D4D\u0DCA\u0E47-\u0E4C\u0E4E\u0EBA\u0EC8-\u0ECC\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F82-\u0F84\u0F86\u0F87\u0FC6\u1037\u1039\u103A\u1063\u1064\u1069-\u106D\u1087-\u108D\u108F\u109A\u109B\u135D-\u135F\u1714\u1715\u17C9-\u17D3\u17DD\u1939-\u193B\u1A75-\u1A7C\u1A7F\u1AB0-\u1ABE\u1AC1-\u1ACB\u1B34\u1B44\u1B6B-\u1B73\u1BAA\u1BAB\u1C36\u1C37\u1C78-\u1C7D\u1CD0-\u1CE8\u1CED\u1CF4\u1CF7-\u1CF9\u1D2C-\u1D6A\u1DC4-\u1DCF\u1DF5-\u1DFF\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u2CEF-\u2CF1\u2E2F\u302A-\u302F\u3099-\u309C\u30FC\uA66F\uA67C\uA67D\uA67F\uA69C\uA69D\uA6F0\uA6F1\uA700-\uA721\uA788-\uA78A\uA7F8\uA7F9\uA8C4\uA8E0-\uA8F1\uA92B-\uA92E\uA953\uA9B3\uA9C0\uA9E5\uAA7B-\uAA7D\uAABF-\uAAC2\uAAF6\uAB5B-\uAB5F\uAB69-\uAB6B\uABEC\uABED\uFB1E\uFE20-\uFE2F\uFF3E\uFF40\uFF70\uFF9E\uFF9F\uFFE3]|\uD800\uDEE0|\uD801[\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD802[\uDEE5\uDEE6]|\uD803[\uDD22-\uDD27\uDEFD-\uDEFF\uDF46-\uDF50\uDF82-\uDF85]|\uD804[\uDC46\uDC70\uDCB9\uDCBA\uDD33\uDD34\uDD73\uDDC0\uDDCA-\uDDCC\uDE35\uDE36\uDEE9\uDEEA\uDF3C\uDF4D\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC42\uDC46\uDCC2\uDCC3\uDDBF\uDDC0\uDE3F\uDEB6\uDEB7\uDF2B]|\uD806[\uDC39\uDC3A\uDD3D\uDD3E\uDD43\uDDE0\uDE34\uDE47\uDE99]|\uD807[\uDC3F\uDD42\uDD44\uDD45\uDD97]|\uD80D[\uDC47-\uDC55]|\uD81A[\uDEF0-\uDEF4\uDF30-\uDF36]|\uD81B[\uDF8F-\uDF9F\uDFF0\uDFF1]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD833[\uDF00-\uDF2D\uDF30-\uDF46]|\uD834[\uDD67-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD]|\uD838[\uDC30-\uDC6D\uDD30-\uDD36\uDEAE\uDEEC-\uDEEF]|\uD83A[\uDCD0-\uDCD6\uDD44-\uDD46\uDD48-\uDD4A])/g,"")}));return(t=(t=(t=(t=(t=(t=(t=(t=t.toUpperCase()).replace(/[^A-Z0-9 ]/g," ")).replace(/\b(LE|LA|LES|DE|DES|DU|THE|AND|A|AN|UN|UNE|ET|EN|AU|AUX|SUR|SOUS|DANS|PAR|POUR|AVEC|SANS|CHEZ|VIA|VERS|DEPUIS|JUSQU'A|JUSQUA|JUSQU'À|JUSQU'À|L'|L'|D'|D'|L'|L')\b/gi," ")).replace(/\bPREMIER\b/g,"1")).replace(/\bDEUXIEME\b/g,"2")).replace(/\bTROISIEME\b/g,"3")).replace(/\bQUATRIEME\b/g,"4")).replace(/\bCINQUIEME\b/g,"5")).replace(/\s+/g," ").trim()}function v(){return b.apply(this,arguments)}function b(){return b=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=o.length>0&&void 0!==o[0]?o[0]:{},window.bddWorkbook){e.next=4;break}return d("Aucune BDD chargée.","error"),e.abrupt("return");case 4:n=XLSX.utils.book_new(),window.bddWorkbook.SheetNames.forEach((function(e){var r=window.bddWorkbook.Sheets[e],o=_toConsumableArray(XLSX.utils.sheet_to_json(r,{header:1}));(t[e]||[]).forEach((function(e){o.some((function(t){return t[0]===e[0]&&t[1]===e[1]}))||o.push(e)}));var a=XLSX.utils.aoa_to_sheet(o);XLSX.utils.book_append_sheet(n,a,e)})),r=XLSX.write(n,{bookType:"xlsx",type:"array"});try{Office.context.document.settings.set("bddWorkbookData",r),Office.context.document.settings.saveAsync(),window.bddWorkbook=n,d("BDD mise à jour avec succès.","success")}catch(e){console.error("Erreur lors de la sauvegarde:",e),d("Erreur lors de la mise à jour de la BDD.","error")}case 8:case"end":return e.stop()}}),e)}))),b.apply(this,arguments)}function w(){return x.apply(this,arguments)}function x(){return(x=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window.bddWorkbook){e.next=3;break}return d("Aucune BDD chargée.","error"),e.abrupt("return");case 3:return t=XLSX.write(window.bddWorkbook,{bookType:"xlsx",type:"array"}),n=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),e.prev=5,r={suggestedName:"bdd_harmonisee_".concat((new Date).toISOString().slice(0,10),".xlsx"),types:[{description:"Fichier Excel",accept:{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}}]},e.next=9,window.showSaveFilePicker(r);case 9:return o=e.sent,e.next=12,o.createWritable();case 12:return a=e.sent,e.next=15,a.write(n);case 15:return e.next=17,a.close();case 17:d("BDD sauvegardée avec succès.","success"),e.next=23;break;case 20:e.prev=20,e.t0=e.catch(5),"AbortError"!==e.t0.name&&(console.error("Erreur lors de la sauvegarde:",e.t0),d("Erreur lors de la sauvegarde de la BDD.","error"));case 23:case"end":return e.stop()}}),e,null,[[5,20]])})))).apply(this,arguments)}function D(){var e=document.getElementById("save-bdd-btn");e&&(window.bddWorkbook?e.style.display="inline-block":e.style.display="none")}function l(e){return e?e.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim():""}function c(e,t){if(e===t)return 1;if(!e||!t)return 0;for(var n=Math.floor(Math.max(e.length,t.length)/2)-1,r=new Array(e.length).fill(!1),o=new Array(t.length).fill(!1),a=0,u=0;u<e.length;u++)for(var i=Math.max(0,u-n),c=Math.min(u+n+1,t.length),s=i;s<c;s++)if(!o[s]&&e[u]===t[s]){r[u]=!0,o[s]=!0,a++;break}if(0===a)return 0;for(var l=0,d=0,f=0;f<e.length;f++)if(r[f]){for(;!o[d];)d++;e[f]!==t[d]&&l++,d++}for(var m=(a/e.length+a/t.length+(a-l/2)/a)/3,h=0,p=0;p<Math.min(4,Math.min(e.length,t.length))&&e[p]===t[p];p++)h++;return m+.1*h*(1-m)}f&&(f.onclick=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a,u,i,s,f,m,h,p,y,v,b,w,x,D,E,k,C,A,_,B,F,S,R,T,I,O;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D=function(e,t){return e||t?e&&t?1-x(e,t)/Math.max(e.length,t.length):0:1},x=function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;for(var n=[],r=0;r<=t.length;r++)n[r]=[r];for(var o=0;o<=e.length;o++)n[0][o]=o;for(var a=1;a<=t.length;a++)for(var u=1;u<=e.length;u++)t.charAt(a-1)===e.charAt(u-1)?n[a][u]=n[a-1][u-1]:n[a][u]=Math.min(n[a-1][u-1]+1,n[a][u-1]+1,n[a-1][u]+1);return n[t.length][e.length]},r=function(){return r=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window.selectedColumnRange){e.next=3;break}return d("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 3:if(t=getCurrentBddWorkbook()){e.next=7;break}return d("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 7:if(n=document.getElementById("theme-select").value,r=t.Sheets[n]){e.next=12;break}return d("Thème non trouvé dans la BDD.","error"),e.abrupt("return",null);case 12:return o=XLSX.utils.sheet_to_json(r,{header:1}),a=[],e.next=16,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.worksheets.getActiveWorksheet().getRange(window.selectedColumnRange)).load(["values","rowCount"]),e.next=4,t.sync();case 4:if(n.values&&Array.isArray(n.values)){e.next=8;break}return d("La sélection est vide ou invalide. Veuillez sélectionner une colonne contenant des données.","error"),a=[],e.abrupt("return");case 8:a=n.values.map((function(e){return e[0]}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 16:return e.abrupt("return",{values:a,referentiel:o,theme:n,sheet:r});case 17:case"end":return e.stop()}}),e)}))),r.apply(this,arguments)},n=function(){return r.apply(this,arguments)},console.log("DEBUG Harmoniser:","selectedColumnRange=",window.selectedColumnRange,"bddFilename=",window.bddFilename),t=window.selectedColumnRange,e.next=8,n();case 8:if(o=e.sent){e.next=11;break}return e.abrupt("return");case 11:for(a=o.values,u=o.referentiel,i=o.theme,o.sheet,s=a.map(l),f={},m={},u.forEach((function(e){void 0!==e[0]&&void 0!==e[1]&&(f[e[0]]=e[1],m[l(e[0])]=e[1])})),h=[],p=0;p<a.length;p++)y=a[p],v=s[p],b="",w="",m.hasOwnProperty(v)?(b=m[v],w="BDD exacte"):(b="",w="Non trouvé"),h.push({avant:y,apres:b,source:w,texteNettoye:v});return E=u.slice(1).map((function(e){return{brut:e[0],nettoye:l(e[0]),harmonise:e[1]}})),h.forEach((function(e){if("Non trouvé"===e.source&&e.texteNettoye){var t=E.map((function(t){var n=.5*D(e.texteNettoye,t.nettoye)+.5*c(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).filter((function(e){return e.score>=(window.similarityThreshold||60)})).sort((function(e,t){return t.score-e.score})).slice(0,3);0===t.length&&(t=E.map((function(t){var n=.5*D(e.texteNettoye,t.nettoye)+.5*c(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).sort((function(e,t){return t.score-e.score})).slice(0,1)),1!==t.length||e.apres||(e.apres=t[0].harmonise,e.source="Suggestion unique"),e.suggestions=t}else e.suggestions=[]})),k=h.length,C=h.filter((function(e){return"BDD exacte"===e.source})).length,A=h.filter((function(e){return"Suggestion"===e.source})).length,_=h.filter((function(e){return"Manuel"===e.source})).length,B=h.filter((function(e){return!e.apres||e.apres===e.avant})).length,F=Math.round((k-B)/k*100),S=document.getElementById("harmonisation-stats"),R=document.getElementById("harmonisation-stats-content"),S&&R&&(R.innerHTML="<b>Statistiques d'harmonisation :</b><br>"+"Lignes traitées : <b>".concat(k,"</b><br>")+"Correspondances exactes : <b>".concat(C,"</b><br>")+"Suggestions utilisées : <b>".concat(A,"</b><br>")+"Validations manuelles : <b>".concat(_,"</b><br>")+"Non harmonisées : <b>".concat(B,"</b><br>")+"Taux de couverture : <b>".concat(F,"%</b>"),S.style.display="block"),(T=document.getElementById("close-stats"))&&S&&(T.onclick=function(){S.style.display="none"}),g(h,t,i),"function"==typeof window.harmonisationMain&&window.harmonisationMain(o,window.selectedColumnRange),I={},O=s.map((function(e,t){if(e in I)return I[e];var n=h[t].apres;return I[e]=n,n})),e.next=37,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){var r,o,a,u,i,c,l,f,m,h,p;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.workbook.worksheets.getActiveWorksheet().getRange(t)).load(["rowCount","columnCount","columnIndex"]),e.next=4,n.sync();case 4:if(o=r.columnCount,a=r.rowCount,r.columnIndex,1===o){e.next=10;break}return d("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 10:for(u=new Set,i=[],c=0;c<a;c++)l=s[c],f=void 0!==O[c]&&null!==O[c]?O[c]:"",l&&!u.has(l)&&""!==f&&(i.push([f]),u.add(l));for(;i.length<a;)i.push([""]);return m=i,(h=r.getOffsetRange(0,1).getResizedRange(a-1,0)).load(["rowCount","columnCount"]),e.next=19,n.sync();case 19:if(p=h.rowCount,h.columnCount,m.length!==p){for(;m.length<p;)m.push(Array(h.columnCount).fill(""));m.length>p&&(m.slice(0,p),_readOnlyError("resultArray"))}return m[0]&&m[0].length!==h.columnCount&&(m.map((function(e){for(var t=e.slice(0,h.columnCount);t.length<h.columnCount;)t.push("");return t})),_readOnlyError("resultArray")),h.values=m,e.next=26,n.sync();case 26:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 37:case"end":return e.stop()}}),e)})))),document.getElementById("download-bdd-btn").onclick=function(){var e=getCurrentBddWorkbook();if(e){var t=XLSX.write(e,{bookType:"xlsx",type:"array"}),n=new Blob([t],{type:"application/octet-stream"}),r=document.createElement("a");r.href=URL.createObjectURL(n),r.download=getCurrentBddFilename()?getCurrentBddFilename().replace(/\.xlsx?$/,"_modifie.xlsx"):"bdd_harmonisation.xlsx",document.body.appendChild(r),r.click(),document.body.removeChild(r)}},document.getElementById("undo-harmonisation-btn").onclick=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.workbook.worksheets.getActiveWorksheet().getRange(r.address),r.values.length!==n.rowCount){for(;r.values.length<n.rowCount;)r.values.push(Array(n.columnCount).fill(""));r.values.length>n.rowCount&&(r.values=r.values.slice(0,n.rowCount))}return r.values[0]&&r.values[0].length!==n.columnCount&&(r.values=r.values.map((function(e){for(var t=e.slice(0,n.columnCount);t.length<n.columnCount;)t.push("");return t}))),n.values=r.values,e.next=6,t.sync();case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 4:document.getElementById("undo-harmonisation-btn").style.display="none",r=null;case 6:case"end":return e.stop()}}),e)}))),h("tool-unique-list",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("values"),e.next=4,t.sync();case 4:return r=Array.from(new Set(n.values.map((function(e){return e[0]})))),n.values=r.map((function(e){return[e]})),e.next=8,t.sync();case 8:m("Liste unique générée dans la sélection.");case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),h("tool-find-replace",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(t=prompt("Texte à rechercher :",""))&&""!==t){e.next=3;break}return e.abrupt("return");case 3:if(null!==(n=prompt("Remplacer par :",""))){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(o=r.workbook.getSelectedRange()).load("values"),e.next=4,r.sync();case 4:return o.values=o.values.map((function(e){return[String(e[0]).split(t).join(n)]})),e.next=7,r.sync();case 7:m("Remplacement effectué.");case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 8:case"end":return e.stop()}}),e)})))),h("tool-count-unique",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("values"),e.next=4,t.sync();case 4:r=new Set(n.values.map((function(e){return e[0]}))),m("Valeurs uniques : ".concat(r.size));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),h("tool-count-occurrences",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,t.sync();case 4:r={},n.values.forEach((function(e){var t=e[0];r[t]=(r[t]||0)+1})),m("Occurrences : "+Object.entries(r).map((function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return"".concat(n," : ").concat(r)})).join(" | "));case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),h("tool-quick-stats",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,u,i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,t.sync();case 4:if(0!==(r=n.values.map((function(e){return parseFloat(e[0])})).filter((function(e){return!isNaN(e)}))).length){e.next=8;break}return m("Aucune valeur numérique."),e.abrupt("return");case 8:r.sort((function(e,t){return e-t})),o=r[0],a=r[r.length-1],u=(r.reduce((function(e,t){return e+t}),0)/r.length).toFixed(2),i=r.length%2==0?((r[r.length/2-1]+r[r.length/2])/2).toFixed(2):r[Math.floor(r.length/2)],m("Min: ".concat(o," | Max: ").concat(a," | Moy: ").concat(u," | Med: ").concat(i));case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),h("tool-search-highlight",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=prompt("Texte à rechercher :","")){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){var r,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,n.sync();case 4:for(r.format.fill,o=0;o<r.values.length;o++)String(r.values[o][0]).includes(t)&&(r.getCell(o,0).format.fill.color="#ffe599");return e.next=8,n.sync();case 8:m("Occurrences surlignées.");case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:case"end":return e.stop()}}),e)})))),h("tool-replace-quick",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=prompt("Texte à rechercher :","")){e.next=3;break}return e.abrupt("return");case 3:if(null!==(n=prompt("Remplacer par :",""))){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(o=r.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,r.sync();case 4:return o.values=o.values.map((function(e){return[String(e[0]).split(t).join(n)]})),e.next=7,r.sync();case 7:m("Remplacement rapide effectué.");case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 8:case"end":return e.stop()}}),e)})))),h("tool-highlight-duplicates",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,t.sync();case 4:for(r=new Set,o=0;o<n.values.length;o++)a=n.values[o][0],r.has(a)?n.getCell(o,0).format.fill.color="#f4cccc":r.add(a);return e.next=8,t.sync();case 8:m("Doublons détectés et surlignés.");case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),Office&&Office.context&&Office.context.officeTheme&&Office.context.officeTheme.addHandlerAsync&&Office.context.officeTheme.addHandlerAsync("officeThemeChanged",applyOfficeThemeColor),window.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("modal-harmonisation");e&&(e.style.display="none");var t=document.getElementById("close-modal");t&&(t.onclick=function(){document.getElementById("modal-harmonisation").style.display="none"}),h("nav-home",(function(){showSection(".welcome-panel"),setActiveNav("nav-home")})),h("nav-harmo",(function(){showSection(".harmonisation-container"),setActiveNav("nav-harmo")}));var n=document.getElementById("select-column-btn");n&&(n.onclick=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=t.workbook.getSelectedRange()).load(["columnIndex","rowCount","columnCount","address"]),e.next=4,t.sync();case 4:if(1===r.columnCount){e.next=7;break}return d("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 7:window.selectedColumnRange=r.address,n.textContent="Colonne sélectionnée : ".concat(r.address),p();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)}))));var r=document.getElementById("load-bdd-btn");r&&(r.onclick=function(){var e=document.getElementById("bdd-file-input");e?(console.log("Ouverture explorateur de fichiers BDD"),d("Ouverture de l'explorateur de fichiers...","info"),e.click()):(d("Erreur : input file BDD introuvable.","error"),console.warn("bdd-file-input manquant"))});var o=document.getElementById("harmonize-btn");o&&(o.onclick=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a,u,i,s,f,m,h,p,y,v,b,w,x,D,E,k,C,A,_,B,F,S,R,T,I,O;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D=function(e,t){return e||t?e&&t?1-x(e,t)/Math.max(e.length,t.length):0:1},x=function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;for(var n=[],r=0;r<=t.length;r++)n[r]=[r];for(var o=0;o<=e.length;o++)n[0][o]=o;for(var a=1;a<=t.length;a++)for(var u=1;u<=e.length;u++)t.charAt(a-1)===e.charAt(u-1)?n[a][u]=n[a-1][u-1]:n[a][u]=Math.min(n[a-1][u-1]+1,n[a][u-1]+1,n[a-1][u]+1);return n[t.length][e.length]},r=function(){return r=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window.selectedColumnRange){e.next=3;break}return d("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 3:if(t=getCurrentBddWorkbook()){e.next=7;break}return d("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 7:if(n=document.getElementById("theme-select").value,r=t.Sheets[n]){e.next=12;break}return d("Thème non trouvé dans la BDD.","error"),e.abrupt("return",null);case 12:return o=XLSX.utils.sheet_to_json(r,{header:1}),a=[],e.next=16,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.worksheets.getActiveWorksheet().getRange(window.selectedColumnRange)).load(["values","rowCount"]),e.next=4,t.sync();case 4:if(n.values&&Array.isArray(n.values)){e.next=8;break}return d("La sélection est vide ou invalide. Veuillez sélectionner une colonne contenant des données.","error"),a=[],e.abrupt("return");case 8:a=n.values.map((function(e){return e[0]}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 16:return e.abrupt("return",{values:a,referentiel:o,theme:n,sheet:r});case 17:case"end":return e.stop()}}),e)}))),r.apply(this,arguments)},n=function(){return r.apply(this,arguments)},console.log("DEBUG Harmoniser:","selectedColumnRange=",window.selectedColumnRange,"bddFilename=",window.bddFilename),t=window.selectedColumnRange,e.next=8,n();case 8:if(o=e.sent){e.next=11;break}return e.abrupt("return");case 11:for(a=o.values,u=o.referentiel,i=o.theme,o.sheet,s=a.map(l),f={},m={},u.forEach((function(e){void 0!==e[0]&&void 0!==e[1]&&(f[e[0]]=e[1],m[l(e[0])]=e[1])})),h=[],p=0;p<a.length;p++)y=a[p],v=s[p],b="",w="",m.hasOwnProperty(v)?(b=m[v],w="BDD exacte"):(b="",w="Non trouvé"),h.push({avant:y,apres:b,source:w,texteNettoye:v});return E=u.slice(1).map((function(e){return{brut:e[0],nettoye:l(e[0]),harmonise:e[1]}})),h.forEach((function(e){if("Non trouvé"===e.source&&e.texteNettoye){var t=E.map((function(t){var n=.5*D(e.texteNettoye,t.nettoye)+.5*c(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).filter((function(e){return e.score>=(window.similarityThreshold||60)})).sort((function(e,t){return t.score-e.score})).slice(0,3);0===t.length&&(t=E.map((function(t){var n=.5*D(e.texteNettoye,t.nettoye)+.5*c(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).sort((function(e,t){return t.score-e.score})).slice(0,1)),1!==t.length||e.apres||(e.apres=t[0].harmonise,e.source="Suggestion unique"),e.suggestions=t}else e.suggestions=[]})),k=h.length,C=h.filter((function(e){return"BDD exacte"===e.source})).length,A=h.filter((function(e){return"Suggestion"===e.source})).length,_=h.filter((function(e){return"Manuel"===e.source})).length,B=h.filter((function(e){return!e.apres||e.apres===e.avant})).length,F=Math.round((k-B)/k*100),S=document.getElementById("harmonisation-stats"),R=document.getElementById("harmonisation-stats-content"),S&&R&&(R.innerHTML="<b>Statistiques d'harmonisation :</b><br>"+"Lignes traitées : <b>".concat(k,"</b><br>")+"Correspondances exactes : <b>".concat(C,"</b><br>")+"Suggestions utilisées : <b>".concat(A,"</b><br>")+"Validations manuelles : <b>".concat(_,"</b><br>")+"Non harmonisées : <b>".concat(B,"</b><br>")+"Taux de couverture : <b>".concat(F,"%</b>"),S.style.display="block"),(T=document.getElementById("close-stats"))&&S&&(T.onclick=function(){S.style.display="none"}),g(h,t,i),"function"==typeof window.harmonisationMain&&window.harmonisationMain(o,window.selectedColumnRange),I={},O=s.map((function(e,t){if(e in I)return I[e];var n=h[t].apres;return I[e]=n,n})),e.next=37,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){var r,o,a,u,i,c,l,f,m,h,p;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.workbook.worksheets.getActiveWorksheet().getRange(t)).load(["rowCount","columnCount","columnIndex"]),e.next=4,n.sync();case 4:if(o=r.columnCount,a=r.rowCount,r.columnIndex,1===o){e.next=10;break}return d("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 10:for(u=new Set,i=[],c=0;c<a;c++)l=s[c],f=void 0!==O[c]&&null!==O[c]?O[c]:"",l&&!u.has(l)&&""!==f&&(i.push([f]),u.add(l));for(;i.length<a;)i.push([""]);return m=i,(h=r.getOffsetRange(0,1).getResizedRange(a-1,0)).load(["rowCount","columnCount"]),e.next=19,n.sync();case 19:if(p=h.rowCount,h.columnCount,m.length!==p){for(;m.length<p;)m.push(Array(h.columnCount).fill(""));m.length>p&&(m.slice(0,p),_readOnlyError("resultArray"))}return m[0]&&m[0].length!==h.columnCount&&(m.map((function(e){for(var t=e.slice(0,h.columnCount);t.length<h.columnCount;)t.push("");return t})),_readOnlyError("resultArray")),h.values=m,e.next=26,n.sync();case 26:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 37:case"end":return e.stop()}}),e)})))),p();var a=document.querySelector(".harmonisation-container");if(a&&!document.getElementById("similarity-threshold")){var u=document.createElement("div");u.style.margin="10px 0 18px 0",u.innerHTML='\n        <label for="similarity-threshold">Seuil de similarité floue : <span id="similarity-threshold-value">60</span>%</label>\n        <input type="range" id="similarity-threshold" min="40" max="100" value="60" step="1" style="vertical-align:middle;width:120px;margin-left:10px;">\n      ',a.insertBefore(u,a.querySelector("#harmo-dest-choice"));var i=document.getElementById("similarity-threshold"),s=document.getElementById("similarity-threshold-value");i.oninput=function(){s.textContent=i.value},window.similarityThreshold=parseInt(i.value,10),i.addEventListener("input",(function(){window.similarityThreshold=parseInt(i.value,10)}))}})),h("select-column-btn",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),h("load-bdd-btn",(function(){})),h("harmonize-btn",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),h("apply-harmonisation-btn",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),h("cancel-harmonisation-btn",(function(){})),h("close-modal",(function(){})),h("download-bdd-btn",(function(){})),h("undo-harmonisation-btn",_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("save-bdd-btn");e&&(e.style.display="inline-block",e.onclick=w),D()}))}Office.onReady((function(e){if(e.host===Office.HostType.Excel){document.getElementById("app-body").style.display="flex";var t=Office.context.document.settings.get("bddWorkbookData"),n=Office.context.document.settings.get("bddWorkbookName"),r=!1;if(t&&n)try{var o=new Uint8Array(t);window.bddWorkbook=XLSX.read(o,{type:"array"}),window.bddFilename=n,r=!0}catch(e){window.bddWorkbook=null,window.bddFilename=null,r=!1}var a=document.getElementById("bdd-filename");if(r&&window.bddWorkbook){a.textContent="Fichier chargé : ".concat(window.bddFilename),a.style.display="inline",document.getElementById("load-bdd-btn").textContent="Changer de BDD";var u=document.getElementById("theme-select");u.innerHTML="",window.bddWorkbook.SheetNames.forEach((function(e){var t=document.createElement("option");t.value=e,t.textContent=e,u.appendChild(t)})),document.getElementById("theme-section").style.display="block",document.getElementById("harmonize-btn").style.display="inline-block",updateMappingTable()}else a.textContent="",a.style.display="none",document.getElementById("theme-section").style.display="none",document.getElementById("harmonize-btn").style.display="none";initHarmonisationHandlers(),showSection(".welcome-panel"),setActiveNav("nav-home"),applyOfficeThemeColor(),initHelpSystem()}}));