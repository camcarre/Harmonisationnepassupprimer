/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={14385:function(e){"use strict";e.exports=function(e,t){return t||(t={}),e?(e=String(e.__esModule?e.default:e),t.hash&&(e+=t.hash),t.maybeNeedQuotes&&/[\t\n\f\r "'=<>`]/.test(e)?'"'.concat(e,'"'):e):e}},54058:function(e,t,n){"use strict";e.exports=n.p+"5e3a794d11d4358a42e6.js"},58394:function(e,t,n){"use strict";e.exports=n.p+"450eec394a3c9f6892d5.css"}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var u=t[r]={exports:{}};return e[r](u,u.exports,n),u.exports}n.m=e,n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e}(),n.b=document.baseURI||self.location.href,function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e){return function(e){if(Array.isArray(e))return o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||r(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=r(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,u=function(){};return{s:u,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:u}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){i=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(i)throw a}}}}function r(e,t){if(e){if("string"==typeof e)return o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function u(e){throw new TypeError('"'+e+'" is read-only')}function a(){"use strict";a=function(){return n};var t,n={},r=Object.prototype,o=r.hasOwnProperty,u="function"==typeof Symbol?Symbol:{},c=u.iterator||"@@iterator",i=u.asyncIterator||"@@asyncIterator",s=u.toStringTag||"@@toStringTag";function l(e,t,n,r){return Object.defineProperty(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r})}try{l({},"")}catch(t){l=function(e,t,n){return e[t]=n}}function f(e,n,r,o){var u=n&&n.prototype instanceof m?n:m,a=Object.create(u.prototype);return l(a,"_invoke",function(e,n,r){var o=1;return function(u,a){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===u)throw a;return{value:t,done:!0}}for(r.method=u,r.arg=a;;){var c=r.delegate;if(c){var i=E(c,r);if(i){if(i===h)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(1===o)throw o=4,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=3;var s=d(e,n,r);if("normal"===s.type){if(o=r.done?4:2,s.arg===h)continue;return{value:s.arg,done:r.done}}"throw"===s.type&&(o=4,r.method="throw",r.arg=s.arg)}}}(e,r,new A(o||[])),!0),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}n.wrap=f;var h={};function m(){}function p(){}function g(){}var y={};l(y,c,(function(){return this}));var v=Object.getPrototypeOf,b=v&&v(v(B([])));b&&b!==r&&o.call(b,c)&&(y=b);var w=g.prototype=m.prototype=Object.create(y);function x(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function D(t,n){function r(u,a,c,i){var s=d(t[u],t,a);if("throw"!==s.type){var l=s.arg,f=l.value;return f&&"object"==e(f)&&o.call(f,"__await")?n.resolve(f.__await).then((function(e){r("next",e,c,i)}),(function(e){r("throw",e,c,i)})):n.resolve(f).then((function(e){l.value=e,c(l)}),(function(e){return r("throw",e,c,i)}))}i(s.arg)}var u;l(this,"_invoke",(function(e,t){function o(){return new n((function(n,o){r(e,t,n,o)}))}return u=u?u.then(o,o):o()}),!0)}function E(e,n){var r=n.method,o=e.i[r];if(o===t)return n.delegate=null,"throw"===r&&e.i.return&&(n.method="return",n.arg=t,E(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),h;var u=d(o,e.i,n.arg);if("throw"===u.type)return n.method="throw",n.arg=u.arg,n.delegate=null,h;var a=u.arg;return a?a.done?(n[e.r]=a.value,n.next=e.n,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,h):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,h)}function k(e){this.tryEntries.push(e)}function C(e){var n=e[4]||{};n.type="normal",n.arg=t,e[4]=n}function A(e){this.tryEntries=[[-1]],e.forEach(k,this),this.reset(!0)}function B(n){if(null!=n){var r=n[c];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var u=-1,a=function e(){for(;++u<n.length;)if(o.call(n,u))return e.value=n[u],e.done=!1,e;return e.value=t,e.done=!0,e};return a.next=a}}throw new TypeError(e(n)+" is not iterable")}return p.prototype=g,l(w,"constructor",g),l(g,"constructor",p),p.displayName=l(g,s,"GeneratorFunction"),n.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},n.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,l(e,s,"GeneratorFunction")),e.prototype=Object.create(w),e},n.awrap=function(e){return{__await:e}},x(D.prototype),l(D.prototype,i,(function(){return this})),n.AsyncIterator=D,n.async=function(e,t,r,o,u){void 0===u&&(u=Promise);var a=new D(f(e,t,r,o),u);return n.isGeneratorFunction(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},x(w),l(w,s,"Generator"),l(w,c,(function(){return this})),l(w,"toString",(function(){return"[object Generator]"})),n.keys=function(e){var t=Object(e),n=[];for(var r in t)n.unshift(r);return function e(){for(;n.length;)if((r=n.pop())in t)return e.value=r,e.done=!1,e;return e.done=!0,e}},n.values=B,A.prototype={constructor:A,reset:function(e){if(this.prev=this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function r(t){a.type="throw",a.arg=e,n.next=t}for(var o=n.tryEntries.length-1;o>=0;--o){var u=this.tryEntries[o],a=u[4],c=this.prev,i=u[1],s=u[2];if(-1===u[0])return r("end"),!1;if(!i&&!s)throw Error("try statement without catch or finally");if(null!=u[0]&&u[0]<=c){if(c<i)return this.method="next",this.arg=t,r(i),!0;if(c<s)return r(s),!1}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r[0]>-1&&r[0]<=this.prev&&this.prev<r[2]){var o=r;break}}o&&("break"===e||"continue"===e)&&o[0]<=t&&t<=o[2]&&(o=null);var u=o?o[4]:{};return u.type=e,u.arg=t,o?(this.method="next",this.next=o[2],h):this.complete(u)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[2]===e)return this.complete(n[4],n[3]),C(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]===e){var r=n[4];if("throw"===r.type){var o=r.arg;C(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={i:B(e),r:n,n:r},"next"===this.method&&(this.arg=t),h}},n}function c(e,t,n,r,o,u,a){try{var c=e[u](a),i=c.value}catch(e){return void n(e)}c.done?t(i):Promise.resolve(i).then(r,o)}function i(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var u=e.apply(t,n);function a(e){c(u,r,o,a,i,"next",e)}function i(e){c(u,r,o,a,i,"throw",e)}a(void 0)}))}}function s(e,t){if(!e&&!t)return 1;if(!e||!t)return 0;var n=function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;for(var n=[],r=0;r<=t.length;r++)n[r]=[r];for(var o=0;o<=e.length;o++)n[0][o]=o;for(var u=1;u<=t.length;u++)for(var a=1;a<=e.length;a++)t.charAt(u-1)===e.charAt(a-1)?n[u][a]=n[u-1][a-1]:n[u][a]=Math.min(n[u-1][a-1]+1,n[u][a-1]+1,n[u-1][a]+1);return n[t.length][e.length]}(e,t);return 1-n/Math.max(e.length,t.length)}function l(){var e,t,n,r,o="#2d89ef";Office.context&&Office.context.host&&"excel"===Office.context.host.toLowerCase()&&(o="#217346"),Office.context&&Office.context.officeTheme&&(o=Office.context.officeTheme.accent1||Office.context.officeTheme.primaryColor||o),document.documentElement.style.setProperty("--primary-color",o),document.documentElement.style.setProperty("--primary-color-hover",(e=o,t=parseInt(e.substring(1,3),16),n=parseInt(e.substring(3,5),16),r=parseInt(e.substring(5,7),16),"#"+(16777216+((t=(t=parseInt(80*t/100))<255?t:255)<<16)+((n=(n=parseInt(80*n/100))<255?n:255)<<8)+(r=(r=parseInt(80*r/100))<255?r:255)).toString(16).slice(1)))}function f(e){document.getElementById("app-body").style.display="flex",document.querySelectorAll(".welcome-panel, .harmonisation-container, .tools-container").forEach((function(e){e.classList.remove("active-section"),e.style.display="none"}));var t=document.querySelector(e);t&&(t.classList.add("active-section"),t.style.display=".tools-container"===e?"flex":"block",t.style.removeProperty("display"),".welcome-panel"===e||".harmonisation-container"===e?t.style.display="block":".tools-container"===e&&(t.style.display="flex"))}function d(e){document.querySelectorAll(".mini-nav-btn").forEach((function(e){return e.classList.remove("active")})),document.getElementById(e).classList.add("active")}function h(){var e=Office.context.document.settings.get("bddWorkbookData");return e?XLSX.read(new Uint8Array(e),{type:"array"}):null}function m(){return Office.context.document.settings.get("bddWorkbookName")||""}function p(){var e=document.getElementById("theme-select").value,t=h();if(t&&e){var n=t.Sheets[e],r=XLSX.utils.sheet_to_json(n,{header:1}),o=document.querySelector("#mapping-table tbody");o.innerHTML="";var u=document.getElementById("search-mapping"),a=document.createElement("datalist");a.id="harmonisation-suggestions";for(var c=new Set,i=1;i<r.length;i++)r[i]&&r[i][1]&&c.add(r[i][1]);c.forEach((function(e){var t=document.createElement("option");t.value=e,a.appendChild(t)})),document.body.appendChild(a),u.setAttribute("list","harmonisation-suggestions");var s=r.slice(1).map((function(e){return{brut:e[0],harm:e[1]}}));u.addEventListener("input",(function(e){l(e.target.value.trim())})),l(),document.getElementById("search-section").style.display="block"}else document.getElementById("search-section").style.display="none";function l(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";o.innerHTML="",s.filter((function(t){if(!e)return!0;var n=e.toLowerCase();return t.brut&&t.brut.toString().toLowerCase().includes(n)||t.harm&&t.harm.toString().toLowerCase().includes(n)})).forEach((function(e){var t=document.createElement("tr");t.innerHTML="\n        <td>".concat(e.brut,'</td>\n        <td class="apres-cell">').concat(e.harm,"</td>\n      "),o.appendChild(t)}))}}Office.onReady((function(e){if(e.host===Office.HostType.Excel){document.getElementById("app-body").style.display="flex";var o=Office.context.document.settings.get("bddWorkbookData"),c=Office.context.document.settings.get("bddWorkbookName"),g=!1;if(o&&c)try{var y=new Uint8Array(o);window.bddWorkbook=XLSX.read(y,{type:"array"}),window.bddFilename=c,g=!0}catch(e){window.bddWorkbook=null,window.bddFilename=null,g=!1}var v=document.getElementById("bdd-filename");if(g&&window.bddWorkbook){v.textContent="Fichier chargé : ".concat(window.bddFilename),v.style.display="inline",document.getElementById("load-bdd-btn").textContent="Changer de BDD";var b=document.getElementById("theme-select");b.innerHTML="",window.bddWorkbook.SheetNames.forEach((function(e){var t=document.createElement("option");t.value=e,t.textContent=e,b.appendChild(t)})),document.getElementById("theme-section").style.display="block",document.getElementById("harmonize-btn").style.display="inline-block",p()}else v.textContent="",v.style.display="none",document.getElementById("theme-section").style.display="none",document.getElementById("harmonize-btn").style.display="none";!function(){document.getElementById("nav-home").addEventListener("click",(function(){f(".welcome-panel"),d("nav-home")})),document.getElementById("nav-harmo").addEventListener("click",(function(){f(".harmonisation-container"),d("nav-harmo")}));var e=document.getElementById("show-help-btn"),o=document.getElementById("help-modal"),c=document.getElementById("close-help-modal");e&&o&&c&&(e.onclick=function(){o.style.display="block"},c.onclick=function(){o.style.display="none"},window.onclick=function(e){e.target===o&&(o.style.display="none")});var g=null,y=document.getElementById("select-column-btn");y?y.onclick=i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=i(a().mark((function e(t){var n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["columnIndex","rowCount","columnCount","address"]),e.next=4,t.sync();case 4:if(1===n.columnCount){e.next=7;break}return k("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 7:window.selectedColumnRange=n.address,y.textContent="Colonne sélectionnée : ".concat(n.address),F();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)}))):console.warn("select-column-btn manquant");var v=document.getElementById("load-bdd-btn");v?v.onclick=function(){var e=document.getElementById("bdd-file-input");e?(console.log("Ouverture explorateur de fichiers BDD"),k("Ouverture de l'explorateur de fichiers...","info"),e.click()):(k("Erreur : input file BDD introuvable.","error"),console.warn("bdd-file-input manquant"))}:console.warn("load-bdd-btn manquant");var b=document.getElementById("bdd-file-input");b?b.onchange=function(e){var t=e.target.files[0];if(t)if(m()!==t.name){var n=new FileReader;n.onload=function(e){var n=new Uint8Array(e.target.result),r=XLSX.read(n,{type:"array"});Office.context.document.settings.set("bddWorkbookData",Array.from(n)),Office.context.document.settings.set("bddWorkbookName",t.name),Office.context.document.settings.saveAsync(),window.bddFilename=t.name,F();var o=document.getElementById("theme-select");o?(o.innerHTML="",r.SheetNames.forEach((function(e){var t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}))):console.warn("theme-select manquant");var u=document.getElementById("theme-section");u&&(u.style.display="block");var a=document.getElementById("harmonize-btn");a&&(a.style.display="inline-block");var c=document.getElementById("bdd-filename");c?(c.textContent="Fichier chargé : ".concat(t.name),c.style.display="inline"):console.warn("bdd-filename manquant"),v&&(v.textContent="Changer de BDD"),p()},n.readAsArrayBuffer(t)}else k("Ce fichier est déjà chargé.","info")}:console.warn("bdd-file-input manquant");var w=document.getElementById("theme-select");function x(e,t){if(!e||!t)return 0;for(var n=function(e,t){if(e===t)return 1;for(var n=e.length,r=t.length,o=Math.floor(Math.max(n,r)/2)-1,u=new Array(n).fill(!1),a=new Array(r).fill(!1),c=0,i=0;i<n;i++)for(var s=Math.max(0,i-o),l=Math.min(i+o+1,r),f=s;f<l;f++)if(!a[f]&&e[i]===t[f]){u[i]=!0,a[f]=!0,c++;break}if(0===c)return 0;for(var d=0,h=0,m=0;m<n;m++)if(u[m]){for(;!a[h];)h++;e[m]!==t[h]&&d++,h++}return(c/n+c/r+(c-(d=Math.floor(d/2)))/c)/3}(e=e.toString(),t=t.toString()),r=0,o=0;o<Math.min(e.length,t.length,4)&&e[o]===t[o];o++)r++;return n+.1*r*(1-n)}w?w.onchange=function(){p()}:console.warn("theme-select manquant");var D=document.getElementById("search-mapping");function E(e){if(!e||"string"!=typeof e)return"";var t=e.normalize("NFD").replace(/\u0300-\u036F/g,"");return(t=(t=t.toUpperCase()).replace(/[^A-Z0-9 ]/g," ")).replace(/\s+/g," ").trim()}function k(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=document.getElementById("global-msg");n.textContent=e,n.style.display="block",n.style.background="error"===t?"#fff1f0":"#fffbe6",n.style.color="error"===t?"#a8071a":"#b36b00",n.style.border="error"===t?"1px solid #ffa39e":"1px solid #ffe58f",setTimeout((function(){n.style.display="none"}),4e3)}D?D.oninput=function(e){var t=e.target.value.toLowerCase(),n=w?w.value:null,r=h();if(r&&n){var o=r.Sheets[n],u=XLSX.utils.sheet_to_json(o,{header:1}),a=document.querySelector("#mapping-table tbody");if(a){if(a.innerHTML="",!t){for(var c=1;c<u.length;c++)if(u[c]){var i=document.createElement("tr");i.innerHTML="<td>".concat(u[c][0]||"","</td><td>").concat(u[c][1]||"","</td><td></td>"),a.appendChild(i)}return}for(var l=[],f=1;f<u.length;f++)if(u[f]&&u[f][0]){var d=(u[f][0]||"").toString(),m=(u[f][1]||"").toString(),p=E(d),g=E(t),y=s(g,p),v=x(g,p),b=Math.round(100*(.5*y+.5*v));(b>=40||d.toLowerCase().includes(t)||m.toLowerCase().includes(t))&&l.push({brut:d,harm:m,score:b})}l.sort((function(e,t){return t.score-e.score})),l.forEach((function(e){var t=document.createElement("tr");t.innerHTML="\n            <td>".concat(e.brut,'</td>\n            <td class="apres-cell">').concat(e.harm,"</td>\n          "),a.appendChild(t)}))}else console.warn("mapping-table tbody manquant")}}:console.warn("search-mapping manquant"),window.normaliserTexte=E,window.showGlobalMsg=k;var C=document.getElementById("harmonize-btn");function A(e){document.getElementById("tool-result-msg").textContent=e,setTimeout((function(){document.getElementById("tool-result-msg").textContent=""}),3500)}function B(e,t){var n=document.getElementById(e);n&&("function"==typeof t?n.onclick=t:t&&"function"==typeof t.then&&(n.onclick=function(){return t.catch((function(e){return console.error("Error in click handler:",e)}))}))}function F(){var e=document.getElementById("harmo-status");if(e){var t=window.selectedColumnRange?"Colonne sélectionnée : <b>".concat(window.selectedColumnRange,"</b>"):'<span style="color:#a8071a">Aucune colonne sélectionnée</span>',n=window.bddFilename?"BDD chargée : <b>".concat(window.bddFilename,"</b>"):'<span style="color:#a8071a">Aucune BDD chargée</span>';e.innerHTML=t+" &nbsp; | &nbsp; "+n}}function S(e,r,o){var u=document.getElementById("modal-harmonisation"),c=document.querySelector("#harmonisation-table tbody");c.innerHTML="";var s=document.getElementById("harmonisation-values");s||((s=document.createElement("datalist")).id="harmonisation-values",document.body.appendChild(s));var l=new Set;if(window.bddWorkbook&&o)for(var f=window.bddWorkbook.Sheets[o],d=XLSX.utils.sheet_to_json(f,{header:1}),h=1;h<d.length;h++)d[h]&&d[h][1]&&l.add(d[h][1]);s.innerHTML=Array.from(l).map((function(e){return'<option value="'.concat(e,'">')})).join("");var m,p=JSON.parse(JSON.stringify(e)),g=new Set,y=[],v=n(e);try{for(v.s();!(m=v.n()).done;){var b=m.value,w=b.apres||b.suggestions&&b.suggestions[0]&&b.suggestions[0].harmonise||"",x=I(w);if(w){if(g.has(x))continue;g.add(x),y.push(b)}else y.push(b)}}catch(e){v.e(e)}finally{v.f()}y.forEach((function(t,r){var o=document.createElement("tr");o.setAttribute("data-idx",e.indexOf(t)),o.style.background="BDD exacte"===t.source?"#f6ffed":"Suggestion unique"===t.source||"Suggestion"===t.source?"#e6fffb":"Manuel"===t.source?"#fff7e6":"#fff1f0";var u,a=t.avant||"",i=t.apres||"",s=t.suggestions||[],l=new Set,f=[],d=n(s);try{for(d.s();!(u=d.n()).done;){var h=u.value;if(h.harmonise){var m=I(h.harmonise);l.has(m)||(l.add(m),f.push(h))}}}catch(e){d.e(e)}finally{d.f()}o.innerHTML='\n        <td class="avant-cell">'.concat(a,'</td>\n        <td class="apres-cell">').concat(i,'</td>\n        <td class="suggestions-cell">\n          ').concat(f.map((function(n,r){return'\n            <button class="suggestion-btn '.concat(i===n.harmonise?"selected":"",'"\n                    data-idx="').concat(e.indexOf(t),'"\n                    data-val="').concat(n.harmonise,'"\n                    style="background: ').concat(i===n.harmonise?"#52c41a":"#f0f5ff",";\n                           color: ").concat(i===n.harmonise?"#fff":"#333",";\n                           font-weight: ").concat(i===n.harmonise?"600":"normal",'">\n              ').concat(n.harmonise," (").concat(n.score,"%)\n            </button>\n          ")})).join(" "),'\n        </td>\n        <td class="manuel-cell">\n          <div style="position: relative;">\n            <input type="text" \n                   class="manuel-input" \n                   value="').concat(i,'"\n                   list="harmonisation-values"\n                   placeholder="Saisie manuelle..."\n                   style="width: 100%; padding: 4px; border: 1px solid #d9d9d9; border-radius: 4px;">\n          </div>\n        </td>\n      '),c.appendChild(o)})),u.style.display="block";var D=document.getElementById("close-modal");D&&(D.onclick=function(){u.style.display="none"});var E=document.getElementById("cancel-harmonisation-btn");E&&(E.onclick=function(){Object.keys(p).forEach((function(t){e[t]=JSON.parse(JSON.stringify(p[t]))})),c.querySelectorAll("tr").forEach((function(t){var n=parseInt(t.getAttribute("data-idx")),r=e[n];if(r){var o=t.querySelector(".apres-cell");o&&(o.textContent=r.apres||"");var u=t.querySelector(".manuel-input");u&&(u.value=r.apres||""),t.style.background="BDD exacte"===r.source?"#f6ffed":"Suggestion unique"===r.source||"Suggestion"===r.source?"#e6fffb":"Manuel"===r.source?"#fff7e6":"#fff1f0",t.querySelectorAll(".suggestion-btn").forEach((function(e){var t=e.getAttribute("data-val"),n=r.apres===t;e.style.background=n?"#52c41a":"#f0f5ff",e.style.color=n?"#fff":"#333",e.style.fontWeight=n?"600":"normal"}))}})),u.style.display="none"});var C=document.getElementById("apply-harmonisation-btn");C&&(C.onclick=i(a().mark((function n(){var o,c,s,l;return a().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(o=e.map((function(e){return[e.apres||""]})),c=document.getElementById("theme-select").value,s=e.filter((function(e){return e.avant&&e.apres&&"BDD exacte"!==e.source})).map((function(e){return[e.avant,e.apres]})),!(s.length>0)){n.next=9;break}return window.newHarmoRowsByTheme||(window.newHarmoRowsByTheme={}),window.newHarmoRowsByTheme[c]||(window.newHarmoRowsByTheme[c]=[]),(l=window.newHarmoRowsByTheme[c]).push.apply(l,t(s)),n.next=9,R(window.newHarmoRowsByTheme);case 9:return n.next=11,Excel.run(function(){var e=i(a().mark((function e(t){var n,u,c;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.worksheets.getActiveWorksheet().getRange(r)).load(["rowCount","columnCount"]),e.next=4,t.sync();case 4:return u=document.querySelector('input[name="harmo-dest"]:checked').value,(c="replace"===u?n:n.getOffsetRange(0,1)).load(["rowCount","columnCount","address"]),e.next=9,t.sync();case 9:for(;o.length<n.rowCount;)o.push([""]);return o.length>n.rowCount&&(o.length=n.rowCount),c.values=o,e.next=14,t.sync();case 14:window.lastHarmonisation={address:c.address,values:o},document.getElementById("undo-harmonisation-btn").style.display="inline-block";case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:u.style.display="none",k("Harmonisation appliquée avec succès.","success");case 13:case"end":return n.stop()}}),n)})))),setTimeout((function(){c.querySelectorAll(".suggestion-btn").forEach((function(t){t.onclick=function(n){var r=parseInt(t.getAttribute("data-idx")),o=t.getAttribute("data-val");if(!isNaN(r)&&e[r]){e[r].apres=o,e[r].source="Suggestion";var u=c.querySelector("tr[data-idx='".concat(r,"']"));if(u){var a=u.querySelector(".apres-cell"),i=u.querySelector(".manuel-input");a&&(a.textContent=o),i&&(i.value=o),u.style.background="#e6fffb",u.querySelectorAll(".suggestion-btn").forEach((function(e){e.style.background="#f0f5ff",e.style.color="#333",e.style.fontWeight="normal"})),t.style.background="#52c41a",t.style.color="#fff",t.style.fontWeight="600"}}else console.warn("Index invalide ou ligne non trouvée:",r)}})),c.querySelectorAll(".manuel-input").forEach((function(t){t.onchange=function(n){var r=t.closest("tr");if(r){var o=parseInt(r.getAttribute("data-idx"));if(!isNaN(o)&&e[o]){var u=t.value.trim();e[o].apres=u,e[o].source="Manuel";var a=r.querySelector(".apres-cell");a&&(a.textContent=u),r.style.background="#fff7e6",r.querySelectorAll(".suggestion-btn").forEach((function(e){e.style.background="#f0f5ff",e.style.color="#333",e.style.fontWeight="normal"}))}else console.warn("Index invalide ou ligne non trouvée:",o)}}}))}),0),M()}function I(e){if(!e||"string"!=typeof e)return"";var t=e.normalize("NFD").replace(/[\0-]/g,(function(e){return e.normalize("NFD").replace(/(?:[\^`\xA8\xAF\xB4\xB7\xB8\u02B0-\u034E\u0350-\u0357\u035D-\u0362\u0374\u0375\u037A\u0384\u0385\u0483-\u0487\u0559\u0591-\u05A1\u05A3-\u05BD\u05BF\u05C1\u05C2\u05C4\u064B-\u0652\u0657\u0658\u06DF\u06E0\u06E5\u06E6\u06EA-\u06EC\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F5\u0818\u0819\u0898-\u089F\u08C9-\u08D2\u08E3-\u08FE\u093C\u094D\u0951-\u0954\u0971\u09BC\u09CD\u0A3C\u0A4D\u0ABC\u0ACD\u0AFD-\u0AFF\u0B3C\u0B4D\u0B55\u0BCD\u0C3C\u0C4D\u0CBC\u0CCD\u0D3B\u0D3C\u0D4D\u0DCA\u0E47-\u0E4C\u0E4E\u0EBA\u0EC8-\u0ECC\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F82-\u0F84\u0F86\u0F87\u0FC6\u1037\u1039\u103A\u1063\u1064\u1069-\u106D\u1087-\u108D\u108F\u109A\u109B\u135D-\u135F\u1714\u1715\u17C9-\u17D3\u17DD\u1939-\u193B\u1A75-\u1A7C\u1A7F\u1AB0-\u1ABE\u1AC1-\u1ACB\u1B34\u1B44\u1B6B-\u1B73\u1BAA\u1BAB\u1C36\u1C37\u1C78-\u1C7D\u1CD0-\u1CE8\u1CED\u1CF4\u1CF7-\u1CF9\u1D2C-\u1D6A\u1DC4-\u1DCF\u1DF5-\u1DFF\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u2CEF-\u2CF1\u2E2F\u302A-\u302F\u3099-\u309C\u30FC\uA66F\uA67C\uA67D\uA67F\uA69C\uA69D\uA6F0\uA6F1\uA700-\uA721\uA788-\uA78A\uA7F8\uA7F9\uA8C4\uA8E0-\uA8F1\uA92B-\uA92E\uA953\uA9B3\uA9C0\uA9E5\uAA7B-\uAA7D\uAABF-\uAAC2\uAAF6\uAB5B-\uAB5F\uAB69-\uAB6B\uABEC\uABED\uFB1E\uFE20-\uFE2F\uFF3E\uFF40\uFF70\uFF9E\uFF9F\uFFE3]|\uD800\uDEE0|\uD801[\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD802[\uDEE5\uDEE6]|\uD803[\uDD22-\uDD27\uDEFD-\uDEFF\uDF46-\uDF50\uDF82-\uDF85]|\uD804[\uDC46\uDC70\uDCB9\uDCBA\uDD33\uDD34\uDD73\uDDC0\uDDCA-\uDDCC\uDE35\uDE36\uDEE9\uDEEA\uDF3C\uDF4D\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC42\uDC46\uDCC2\uDCC3\uDDBF\uDDC0\uDE3F\uDEB6\uDEB7\uDF2B]|\uD806[\uDC39\uDC3A\uDD3D\uDD3E\uDD43\uDDE0\uDE34\uDE47\uDE99]|\uD807[\uDC3F\uDD42\uDD44\uDD45\uDD97]|\uD80D[\uDC47-\uDC55]|\uD81A[\uDEF0-\uDEF4\uDF30-\uDF36]|\uD81B[\uDF8F-\uDF9F\uDFF0\uDFF1]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD833[\uDF00-\uDF2D\uDF30-\uDF46]|\uD834[\uDD67-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD]|\uD838[\uDC30-\uDC6D\uDD30-\uDD36\uDEAE\uDEEC-\uDEEF]|\uD83A[\uDCD0-\uDCD6\uDD44-\uDD46\uDD48-\uDD4A])/g,"")}));return(t=(t=(t=(t=(t=(t=(t=(t=t.toUpperCase()).replace(/[^A-Z0-9 ]/g," ")).replace(/\b(LE|LA|LES|DE|DES|DU|THE|AND|A|AN|UN|UNE|ET|EN|AU|AUX|SUR|SOUS|DANS|PAR|POUR|AVEC|SANS|CHEZ|VIA|VERS|DEPUIS|JUSQU'A|JUSQUA|JUSQU'À|JUSQU'À|L'|L'|D'|D'|L'|L')\b/gi," ")).replace(/\bPREMIER\b/g,"1")).replace(/\bDEUXIEME\b/g,"2")).replace(/\bTROISIEME\b/g,"3")).replace(/\bQUATRIEME\b/g,"4")).replace(/\bCINQUIEME\b/g,"5")).replace(/\s+/g," ").trim()}function R(){return O.apply(this,arguments)}function O(){return O=i(a().mark((function e(){var n,r,o,u=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=u.length>0&&void 0!==u[0]?u[0]:{},window.bddWorkbook){e.next=4;break}return k("Aucune BDD chargée.","error"),e.abrupt("return");case 4:r=XLSX.utils.book_new(),window.bddWorkbook.SheetNames.forEach((function(e){var o=window.bddWorkbook.Sheets[e],u=t(XLSX.utils.sheet_to_json(o,{header:1}));(n[e]||[]).forEach((function(e){u.some((function(t){return t[0]===e[0]&&t[1]===e[1]}))||u.push(e)}));var a=XLSX.utils.aoa_to_sheet(u);XLSX.utils.book_append_sheet(r,a,e)})),o=XLSX.write(r,{bookType:"xlsx",type:"array"});try{Office.context.document.settings.set("bddWorkbookData",o),Office.context.document.settings.saveAsync(),window.bddWorkbook=r,k("BDD mise à jour avec succès.","success")}catch(e){console.error("Erreur lors de la sauvegarde:",e),k("Erreur lors de la mise à jour de la BDD.","error")}case 8:case"end":return e.stop()}}),e)}))),O.apply(this,arguments)}function L(){return T.apply(this,arguments)}function T(){return(T=i(a().mark((function e(){var t,n,r,o,u;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window.bddWorkbook){e.next=3;break}return k("Aucune BDD chargée.","error"),e.abrupt("return");case 3:return t=XLSX.write(window.bddWorkbook,{bookType:"xlsx",type:"array"}),n=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),e.prev=5,r={suggestedName:"bdd_harmonisee_".concat((new Date).toISOString().slice(0,10),".xlsx"),types:[{description:"Fichier Excel",accept:{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}}]},e.next=9,window.showSaveFilePicker(r);case 9:return o=e.sent,e.next=12,o.createWritable();case 12:return u=e.sent,e.next=15,u.write(n);case 15:return e.next=17,u.close();case 17:k("BDD sauvegardée avec succès.","success"),e.next=23;break;case 20:e.prev=20,e.t0=e.catch(5),"AbortError"!==e.t0.name&&(console.error("Erreur lors de la sauvegarde:",e.t0),k("Erreur lors de la sauvegarde de la BDD.","error"));case 23:case"end":return e.stop()}}),e,null,[[5,20]])})))).apply(this,arguments)}function M(){var e=document.getElementById("save-bdd-btn");e&&(window.bddWorkbook?e.style.display="inline-block":e.style.display="none")}function E(e){return e?e.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim():""}function x(e,t){if(e===t)return 1;if(!e||!t)return 0;for(var n=Math.floor(Math.max(e.length,t.length)/2)-1,r=new Array(e.length).fill(!1),o=new Array(t.length).fill(!1),u=0,a=0;a<e.length;a++)for(var c=Math.max(0,a-n),i=Math.min(a+n+1,t.length),s=c;s<i;s++)if(!o[s]&&e[a]===t[s]){r[a]=!0,o[s]=!0,u++;break}if(0===u)return 0;for(var l=0,f=0,d=0;d<e.length;d++)if(r[d]){for(;!o[f];)f++;e[d]!==t[f]&&l++,f++}for(var h=(u/e.length+u/t.length+(u-l/2)/u)/3,m=0,p=0;p<Math.min(4,Math.min(e.length,t.length))&&e[p]===t[p];p++)m++;return h+.1*m*(1-h)}C&&(C.onclick=i(a().mark((function e(){var t,n,r,o,c,s,l,f,d,m,p,g,y,v,b,w,D,C,A,B,F,I,R,O,L,T,M,N,q,j;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return C=function(e,t){return e||t?e&&t?1-D(e,t)/Math.max(e.length,t.length):0:1},D=function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;for(var n=[],r=0;r<=t.length;r++)n[r]=[r];for(var o=0;o<=e.length;o++)n[0][o]=o;for(var u=1;u<=t.length;u++)for(var a=1;a<=e.length;a++)t.charAt(u-1)===e.charAt(a-1)?n[u][a]=n[u-1][a-1]:n[u][a]=Math.min(n[u-1][a-1]+1,n[u][a-1]+1,n[u-1][a]+1);return n[t.length][e.length]},r=function(){return r=i(a().mark((function e(){var t,n,r,o,u;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window.selectedColumnRange){e.next=3;break}return k("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 3:if(t=h()){e.next=7;break}return k("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 7:if(n=document.getElementById("theme-select").value,r=t.Sheets[n]){e.next=12;break}return k("Thème non trouvé dans la BDD.","error"),e.abrupt("return",null);case 12:return o=XLSX.utils.sheet_to_json(r,{header:1}),u=[],e.next=16,Excel.run(function(){var e=i(a().mark((function e(t){var n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.worksheets.getActiveWorksheet().getRange(window.selectedColumnRange)).load(["values","rowCount"]),e.next=4,t.sync();case 4:if(n.values&&Array.isArray(n.values)){e.next=8;break}return k("La sélection est vide ou invalide. Veuillez sélectionner une colonne contenant des données.","error"),u=[],e.abrupt("return");case 8:u=n.values.map((function(e){return e[0]}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 16:return e.abrupt("return",{values:u,referentiel:o,theme:n,sheet:r});case 17:case"end":return e.stop()}}),e)}))),r.apply(this,arguments)},n=function(){return r.apply(this,arguments)},console.log("DEBUG Harmoniser:","selectedColumnRange=",window.selectedColumnRange,"bddFilename=",window.bddFilename),t=window.selectedColumnRange,e.next=8,n();case 8:if(o=e.sent){e.next=11;break}return e.abrupt("return");case 11:for(c=o.values,s=o.referentiel,l=o.theme,o.sheet,f=c.map(E),d={},m={},s.forEach((function(e){void 0!==e[0]&&void 0!==e[1]&&(d[e[0]]=e[1],m[E(e[0])]=e[1])})),p=[],g=0;g<c.length;g++)y=c[g],v=f[g],b="",w="",m.hasOwnProperty(v)?(b=m[v],w="BDD exacte"):(b="",w="Non trouvé"),p.push({avant:y,apres:b,source:w,texteNettoye:v});return A=s.slice(1).map((function(e){return{brut:e[0],nettoye:E(e[0]),harmonise:e[1]}})),p.forEach((function(e){if("Non trouvé"===e.source&&e.texteNettoye){var t=A.map((function(t){var n=.5*C(e.texteNettoye,t.nettoye)+.5*x(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).filter((function(e){return e.score>=(window.similarityThreshold||60)})).sort((function(e,t){return t.score-e.score})).slice(0,3);0===t.length&&(t=A.map((function(t){var n=.5*C(e.texteNettoye,t.nettoye)+.5*x(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).sort((function(e,t){return t.score-e.score})).slice(0,1)),1!==t.length||e.apres||(e.apres=t[0].harmonise,e.source="Suggestion unique"),e.suggestions=t}else e.suggestions=[]})),B=p.length,F=p.filter((function(e){return"BDD exacte"===e.source})).length,I=p.filter((function(e){return"Suggestion"===e.source})).length,R=p.filter((function(e){return"Manuel"===e.source})).length,O=p.filter((function(e){return!e.apres||e.apres===e.avant})).length,L=Math.round((B-O)/B*100),T=document.getElementById("harmonisation-stats"),M=document.getElementById("harmonisation-stats-content"),T&&M&&(M.innerHTML="<b>Statistiques d'harmonisation :</b><br>"+"Lignes traitées : <b>".concat(B,"</b><br>")+"Correspondances exactes : <b>".concat(F,"</b><br>")+"Suggestions utilisées : <b>".concat(I,"</b><br>")+"Validations manuelles : <b>".concat(R,"</b><br>")+"Non harmonisées : <b>".concat(O,"</b><br>")+"Taux de couverture : <b>".concat(L,"%</b>"),T.style.display="block"),(N=document.getElementById("close-stats"))&&T&&(N.onclick=function(){T.style.display="none"}),S(p,t,l),"function"==typeof window.harmonisationMain&&window.harmonisationMain(o,window.selectedColumnRange),q={},j=f.map((function(e,t){if(e in q)return q[e];var n=p[t].apres;return q[e]=n,n})),e.next=37,Excel.run(function(){var e=i(a().mark((function e(n){var r,o,c,i,s,l,d,h,m,p,g;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.workbook.worksheets.getActiveWorksheet().getRange(t)).load(["rowCount","columnCount","columnIndex"]),e.next=4,n.sync();case 4:if(o=r.columnCount,c=r.rowCount,r.columnIndex,1===o){e.next=10;break}return k("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 10:for(i=new Set,s=[],l=0;l<c;l++)d=f[l],h=void 0!==j[l]&&null!==j[l]?j[l]:"",d&&!i.has(d)&&""!==h&&(s.push([h]),i.add(d));for(;s.length<c;)s.push([""]);return m=s,(p=r.getOffsetRange(0,1).getResizedRange(c-1,0)).load(["rowCount","columnCount"]),e.next=19,n.sync();case 19:if(g=p.rowCount,p.columnCount,m.length!==g){for(;m.length<g;)m.push(Array(p.columnCount).fill(""));m.length>g&&(m.slice(0,g),u("resultArray"))}return m[0]&&m[0].length!==p.columnCount&&(m.map((function(e){for(var t=e.slice(0,p.columnCount);t.length<p.columnCount;)t.push("");return t})),u("resultArray")),p.values=m,e.next=26,n.sync();case 26:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 37:case"end":return e.stop()}}),e)})))),document.getElementById("download-bdd-btn").onclick=function(){var e=h();if(e){var t=XLSX.write(e,{bookType:"xlsx",type:"array"}),n=new Blob([t],{type:"application/octet-stream"}),r=document.createElement("a");r.href=URL.createObjectURL(n),r.download=m()?m().replace(/\.xlsx?$/,"_modifie.xlsx"):"bdd_harmonisation.xlsx",document.body.appendChild(r),r.click(),document.body.removeChild(r)}},document.getElementById("undo-harmonisation-btn").onclick=i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Excel.run(function(){var e=i(a().mark((function e(t){var n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.workbook.worksheets.getActiveWorksheet().getRange(g.address),g.values.length!==n.rowCount){for(;g.values.length<n.rowCount;)g.values.push(Array(n.columnCount).fill(""));g.values.length>n.rowCount&&(g.values=g.values.slice(0,n.rowCount))}return g.values[0]&&g.values[0].length!==n.columnCount&&(g.values=g.values.map((function(e){for(var t=e.slice(0,n.columnCount);t.length<n.columnCount;)t.push("");return t}))),n.values=g.values,e.next=6,t.sync();case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 4:document.getElementById("undo-harmonisation-btn").style.display="none",g=null;case 6:case"end":return e.stop()}}),e)}))),B("tool-unique-list",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=i(a().mark((function e(t){var n,r;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("values"),e.next=4,t.sync();case 4:return r=Array.from(new Set(n.values.map((function(e){return e[0]})))),n.values=r.map((function(e){return[e]})),e.next=8,t.sync();case 8:A("Liste unique générée dans la sélection.");case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),B("tool-find-replace",i(a().mark((function e(){var t,n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(t=prompt("Texte à rechercher :",""))&&""!==t){e.next=3;break}return e.abrupt("return");case 3:if(null!==(n=prompt("Remplacer par :",""))){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,Excel.run(function(){var e=i(a().mark((function e(r){var o;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(o=r.workbook.getSelectedRange()).load("values"),e.next=4,r.sync();case 4:return o.values=o.values.map((function(e){return[String(e[0]).split(t).join(n)]})),e.next=7,r.sync();case 7:A("Remplacement effectué.");case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 8:case"end":return e.stop()}}),e)})))),B("tool-count-unique",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=i(a().mark((function e(t){var n,r;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("values"),e.next=4,t.sync();case 4:r=new Set(n.values.map((function(e){return e[0]}))),A("Valeurs uniques : ".concat(r.size));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),B("tool-count-occurrences",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=i(a().mark((function e(t){var n,o;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,t.sync();case 4:o={},n.values.forEach((function(e){var t=e[0];o[t]=(o[t]||0)+1})),A("Occurrences : "+Object.entries(o).map((function(e){var t,n,o=(n=2,function(e){if(Array.isArray(e))return e}(t=e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,u,a,c=[],i=!0,s=!1;try{if(u=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;i=!1}else for(;!(i=(r=u.call(n)).done)&&(c.push(r.value),c.length!==t);i=!0);}catch(e){s=!0,o=e}finally{try{if(!i&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(s)throw o}}return c}}(t,n)||r(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),u=o[0],a=o[1];return"".concat(u," : ").concat(a)})).join(" | "));case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),B("tool-quick-stats",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=i(a().mark((function e(t){var n,r,o,u,c,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,t.sync();case 4:if(0!==(r=n.values.map((function(e){return parseFloat(e[0])})).filter((function(e){return!isNaN(e)}))).length){e.next=8;break}return A("Aucune valeur numérique."),e.abrupt("return");case 8:r.sort((function(e,t){return e-t})),o=r[0],u=r[r.length-1],c=(r.reduce((function(e,t){return e+t}),0)/r.length).toFixed(2),i=r.length%2==0?((r[r.length/2-1]+r[r.length/2])/2).toFixed(2):r[Math.floor(r.length/2)],A("Min: ".concat(o," | Max: ").concat(u," | Moy: ").concat(c," | Med: ").concat(i));case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),B("tool-search-highlight",i(a().mark((function e(){var t;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=prompt("Texte à rechercher :","")){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,Excel.run(function(){var e=i(a().mark((function e(n){var r,o;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,n.sync();case 4:for(r.format.fill,o=0;o<r.values.length;o++)String(r.values[o][0]).includes(t)&&(r.getCell(o,0).format.fill.color="#ffe599");return e.next=8,n.sync();case 8:A("Occurrences surlignées.");case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:case"end":return e.stop()}}),e)})))),B("tool-replace-quick",i(a().mark((function e(){var t,n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=prompt("Texte à rechercher :","")){e.next=3;break}return e.abrupt("return");case 3:if(null!==(n=prompt("Remplacer par :",""))){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,Excel.run(function(){var e=i(a().mark((function e(r){var o;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(o=r.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,r.sync();case 4:return o.values=o.values.map((function(e){return[String(e[0]).split(t).join(n)]})),e.next=7,r.sync();case 7:A("Remplacement rapide effectué.");case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 8:case"end":return e.stop()}}),e)})))),B("tool-highlight-duplicates",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=i(a().mark((function e(t){var n,r,o,u;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load(["values","rowCount","columnCount"]),e.next=4,t.sync();case 4:for(r=new Set,o=0;o<n.values.length;o++)u=n.values[o][0],r.has(u)?n.getCell(o,0).format.fill.color="#f4cccc":r.add(u);return e.next=8,t.sync();case 8:A("Doublons détectés et surlignés.");case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)})))),Office&&Office.context&&Office.context.officeTheme&&Office.context.officeTheme.addHandlerAsync&&Office.context.officeTheme.addHandlerAsync("officeThemeChanged",l),window.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("modal-harmonisation");e&&(e.style.display="none");var t=document.getElementById("close-modal");t&&(t.onclick=function(){document.getElementById("modal-harmonisation").style.display="none"}),B("nav-home",(function(){f(".welcome-panel"),d("nav-home")})),B("nav-harmo",(function(){f(".harmonisation-container"),d("nav-harmo")}));var n=document.getElementById("select-column-btn");n&&(n.onclick=i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Excel.run(function(){var e=i(a().mark((function e(t){var r;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=t.workbook.getSelectedRange()).load(["columnIndex","rowCount","columnCount","address"]),e.next=4,t.sync();case 4:if(1===r.columnCount){e.next=7;break}return k("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 7:window.selectedColumnRange=r.address,n.textContent="Colonne sélectionnée : ".concat(r.address),F();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:case"end":return e.stop()}}),e)}))));var r=document.getElementById("load-bdd-btn");r&&(r.onclick=function(){var e=document.getElementById("bdd-file-input");e?(console.log("Ouverture explorateur de fichiers BDD"),k("Ouverture de l'explorateur de fichiers...","info"),e.click()):(k("Erreur : input file BDD introuvable.","error"),console.warn("bdd-file-input manquant"))});var o=document.getElementById("harmonize-btn");o&&(o.onclick=i(a().mark((function e(){var t,n,r,o,c,s,l,f,d,m,p,g,y,v,b,w,D,C,A,B,F,I,R,O,L,T,M,N,q,j;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return C=function(e,t){return e||t?e&&t?1-D(e,t)/Math.max(e.length,t.length):0:1},D=function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;for(var n=[],r=0;r<=t.length;r++)n[r]=[r];for(var o=0;o<=e.length;o++)n[0][o]=o;for(var u=1;u<=t.length;u++)for(var a=1;a<=e.length;a++)t.charAt(u-1)===e.charAt(a-1)?n[u][a]=n[u-1][a-1]:n[u][a]=Math.min(n[u-1][a-1]+1,n[u][a-1]+1,n[u-1][a]+1);return n[t.length][e.length]},r=function(){return r=i(a().mark((function e(){var t,n,r,o,u;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window.selectedColumnRange){e.next=3;break}return k("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 3:if(t=h()){e.next=7;break}return k("Veuillez sélectionner une colonne et charger la BDD.","error"),e.abrupt("return",null);case 7:if(n=document.getElementById("theme-select").value,r=t.Sheets[n]){e.next=12;break}return k("Thème non trouvé dans la BDD.","error"),e.abrupt("return",null);case 12:return o=XLSX.utils.sheet_to_json(r,{header:1}),u=[],e.next=16,Excel.run(function(){var e=i(a().mark((function e(t){var n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.worksheets.getActiveWorksheet().getRange(window.selectedColumnRange)).load(["values","rowCount"]),e.next=4,t.sync();case 4:if(n.values&&Array.isArray(n.values)){e.next=8;break}return k("La sélection est vide ou invalide. Veuillez sélectionner une colonne contenant des données.","error"),u=[],e.abrupt("return");case 8:u=n.values.map((function(e){return e[0]}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 16:return e.abrupt("return",{values:u,referentiel:o,theme:n,sheet:r});case 17:case"end":return e.stop()}}),e)}))),r.apply(this,arguments)},n=function(){return r.apply(this,arguments)},console.log("DEBUG Harmoniser:","selectedColumnRange=",window.selectedColumnRange,"bddFilename=",window.bddFilename),t=window.selectedColumnRange,e.next=8,n();case 8:if(o=e.sent){e.next=11;break}return e.abrupt("return");case 11:for(c=o.values,s=o.referentiel,l=o.theme,o.sheet,f=c.map(E),d={},m={},s.forEach((function(e){void 0!==e[0]&&void 0!==e[1]&&(d[e[0]]=e[1],m[E(e[0])]=e[1])})),p=[],g=0;g<c.length;g++)y=c[g],v=f[g],b="",w="",m.hasOwnProperty(v)?(b=m[v],w="BDD exacte"):(b="",w="Non trouvé"),p.push({avant:y,apres:b,source:w,texteNettoye:v});return A=s.slice(1).map((function(e){return{brut:e[0],nettoye:E(e[0]),harmonise:e[1]}})),p.forEach((function(e){if("Non trouvé"===e.source&&e.texteNettoye){var t=A.map((function(t){var n=.5*C(e.texteNettoye,t.nettoye)+.5*x(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).filter((function(e){return e.score>=(window.similarityThreshold||60)})).sort((function(e,t){return t.score-e.score})).slice(0,3);0===t.length&&(t=A.map((function(t){var n=.5*C(e.texteNettoye,t.nettoye)+.5*x(e.texteNettoye,t.nettoye);return{brut:t.brut,harmonise:t.harmonise,score:Math.round(100*n),scoreRaw:n}})).sort((function(e,t){return t.score-e.score})).slice(0,1)),1!==t.length||e.apres||(e.apres=t[0].harmonise,e.source="Suggestion unique"),e.suggestions=t}else e.suggestions=[]})),B=p.length,F=p.filter((function(e){return"BDD exacte"===e.source})).length,I=p.filter((function(e){return"Suggestion"===e.source})).length,R=p.filter((function(e){return"Manuel"===e.source})).length,O=p.filter((function(e){return!e.apres||e.apres===e.avant})).length,L=Math.round((B-O)/B*100),T=document.getElementById("harmonisation-stats"),M=document.getElementById("harmonisation-stats-content"),T&&M&&(M.innerHTML="<b>Statistiques d'harmonisation :</b><br>"+"Lignes traitées : <b>".concat(B,"</b><br>")+"Correspondances exactes : <b>".concat(F,"</b><br>")+"Suggestions utilisées : <b>".concat(I,"</b><br>")+"Validations manuelles : <b>".concat(R,"</b><br>")+"Non harmonisées : <b>".concat(O,"</b><br>")+"Taux de couverture : <b>".concat(L,"%</b>"),T.style.display="block"),(N=document.getElementById("close-stats"))&&T&&(N.onclick=function(){T.style.display="none"}),S(p,t,l),"function"==typeof window.harmonisationMain&&window.harmonisationMain(o,window.selectedColumnRange),q={},j=f.map((function(e,t){if(e in q)return q[e];var n=p[t].apres;return q[e]=n,n})),e.next=37,Excel.run(function(){var e=i(a().mark((function e(n){var r,o,c,i,s,l,d,h,m,p,g;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.workbook.worksheets.getActiveWorksheet().getRange(t)).load(["rowCount","columnCount","columnIndex"]),e.next=4,n.sync();case 4:if(o=r.columnCount,c=r.rowCount,r.columnIndex,1===o){e.next=10;break}return k("Veuillez sélectionner une seule colonne.","error"),e.abrupt("return");case 10:for(i=new Set,s=[],l=0;l<c;l++)d=f[l],h=void 0!==j[l]&&null!==j[l]?j[l]:"",d&&!i.has(d)&&""!==h&&(s.push([h]),i.add(d));for(;s.length<c;)s.push([""]);return m=s,(p=r.getOffsetRange(0,1).getResizedRange(c-1,0)).load(["rowCount","columnCount"]),e.next=19,n.sync();case 19:if(g=p.rowCount,p.columnCount,m.length!==g){for(;m.length<g;)m.push(Array(p.columnCount).fill(""));m.length>g&&(m.slice(0,g),u("resultArray"))}return m[0]&&m[0].length!==p.columnCount&&(m.map((function(e){for(var t=e.slice(0,p.columnCount);t.length<p.columnCount;)t.push("");return t})),u("resultArray")),p.values=m,e.next=26,n.sync();case 26:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 37:case"end":return e.stop()}}),e)})))),F();var c=document.querySelector(".harmonisation-container");if(c&&!document.getElementById("similarity-threshold")){var s=document.createElement("div");s.style.margin="10px 0 18px 0",s.innerHTML='\n        <label for="similarity-threshold">Seuil de similarité floue : <span id="similarity-threshold-value">60</span>%</label>\n        <input type="range" id="similarity-threshold" min="40" max="100" value="60" step="1" style="vertical-align:middle;width:120px;margin-left:10px;">\n      ',c.insertBefore(s,c.querySelector("#harmo-dest-choice"));var l=document.getElementById("similarity-threshold"),m=document.getElementById("similarity-threshold-value");l.oninput=function(){m.textContent=l.value},window.similarityThreshold=parseInt(l.value,10),l.addEventListener("input",(function(){window.similarityThreshold=parseInt(l.value,10)}))}})),B("select-column-btn",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),B("load-bdd-btn",(function(){})),B("harmonize-btn",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),B("apply-harmonisation-btn",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),B("cancel-harmonisation-btn",(function(){})),B("close-modal",(function(){})),B("download-bdd-btn",(function(){})),B("undo-harmonisation-btn",i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))),document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("save-bdd-btn");e&&(e.style.display="inline-block",e.onclick=L),M()}))}(),f(".welcome-panel"),d("nav-home"),l(),(w=document.createElement("button")).id="show-help-btn",w.innerHTML="?",w.style.cssText="position:fixed;top:20px;right:20px;width:32px;height:32px;border-radius:4px;background:#1890ff;color:white;font-size:16px;border:none;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;align-items:center;justify-content:center;",document.body.appendChild(w),w.onclick=function(){var e=document.getElementById("help-modal");e&&(e.style.display="block")}}var w}))}(),function(){"use strict";var e=n(14385),t=n.n(e),r=new URL(n(58394),n.b),o=new URL(n(54058),n.b);t()(r),t()(o)}()}();
//# sourceMappingURL=taskpane.js.map